<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>

<!-- STATION TYPES -->

	<!-- Commonwealth Colony -->

	<StationType UNID="&stCommonwealthColony;"
			name=				"Commonwealth colony"
			sovereign=			"&svCommonwealth;"
			inherit=			"&baCommonwealthStation;"
				 
			attributes=			"commonwealth, commonwealthCustoms, friendly, generic, human, majorStation, primary, populated"
				 
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"

			level=				"4"
			size=				"390"
			armorID=			"&itPlasteelPlate;"
			hitPoints=			"320"
			multiHull=			"true"
			regen=              "6"
			shipRegen=			"4"
				 
			canAttack=			"true"
			fireRateAdj=		"80"
			explosionType=		"&vtBlastExplosion2;"
			ejectaType=			"&vtWreckEjecta;"
			>
		
		<!-- Encounter Info -->

		<Encounter
				levelFrequency=		"cuc-- ----- ----- ----- -----"
				locationCriteria=	"-outerSystem, +planetary"
				enemyExclusionRadius="50"
				/>

		<Names noArticle="true">
			Agricola Station; Britannia Station; Canterbury Station;
			Devonshire Colony; Enterprise Station; Farsend Station;
			Grenoble Colony; Hellas Station; Independence Station;
			Janus Colony; Koran Station; Lexington Colony; Massachusetts Colony;
			Nakura Colony; Ontario Station; Paduan Station; Qatar Station;
			Ryad Colony; Santiago Station; Tango Colony; Umber Station;
			Victory Colony; Winchell Station; %s Colony; %s Alpha Station;
			%s Beta Station; %s Gamma Station; %s Epsilon Station;
			Anacreon Colony %1%0%0%0; Anacreon Colony %1%0%0; Anacreon Colony %1%0%0;
			Anacreon Colony %1%0%0; Anacreon Colony %1%0%0
		</Names>
		
		<!-- Trade and Items -->

		<Trade currency="credit" max="50000" replenish="2500">
			<Sell	criteria="m +commonwealth; +basicAmmo; -illegal; -notForSale; -notStandard;" priceAdj="115" inventoryAdj="200" levelFrequency="systemLevel:ruc|c|cur"/>
			<Sell	criteria="*NU -Illegal; -ID; -NotForSale;"	priceAdj="110"/>
			<Buy	criteria="amswNU -Illegal; -NotForSale;"		priceAdj="50"/>
			<Buy	criteria="*NU -Illegal; -ID; -NotForSale;"	priceAdj="90"/>
			<Buy	criteria="*NU -Illegal; -ID;"				priceAdj="10"/>
			
			<Refuel			criteria="f +BasicFuel; L:1-5;" priceAdj="93"/>
			<RepairArmor	criteria="a L:1-5;" priceAdj="100"/>
			<ReplaceArmor	criteria="a L:1-5;" priceAdj="100"/>
			<InstallDevice	criteria="d L:1-5;" priceAdj="100"/>
			<RemoveDevice	criteria="d L:1-5;" priceAdj="100"/>
		</Trade>

		<Items>
			<RandomItem count="10" 
					criteria=		"ad L:1-5; -Illegal; -Military; -Alien; -Specialty; -NotStandard; -NotForSale;"
					levelFrequency=	"systemLevel:u|c|crv"
					/>
			<RandomItem count="10" 
					criteria=		"*~ad -Illegal; -Military; -Alien; -Specialty; -NotStandard; -NotForSale;"
					levelFrequency=	"systemLevel:ru|c|cur"
					/>
			<Item count="4d12"	item="&itHelium3FuelRod;" />
		</Items>
		
		<!-- Configuration -->
		
		<Devices>
			<Device deviceID="&itTeV9Blaster;"	omnidirectional="true"/>
		</Devices>
		
		<!-- Ships and Defenses -->

		<Ships>
			<Lookup count="2" table="&tbCommDefenders;"/>
			<Lookup count="1d4" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<Reinforcements minShips="5">
			<Table>
				<Lookup chance="75" table="&tbCommDefenders;"/>
				<Lookup chance="25" table="&tbCommPrivateCrafts;"/>
			</Table>
		</Reinforcements>
		
		<!-- Image and Effects -->
		
		<Image imageID="&rsCommonwealthColony;" imageWidth="320" imageHeight="290" viewportRatio="0.05"/>

		<DockingPorts
				portCount=		"10"
				portRadius=		"175"
				>
		</DockingPorts>
		
		<!-- Dock Screen -->

		<DockScreens>
			<Main>
				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDescTranslate gScreen 'descWelcome)
						</OnPaneInit>

						<Actions>
							<Action id="actionMainHall" default="1">
								(rpgMissionAssignment {
									missionCriteria: (cat "n +commonwealthColony; =" (sysGetLevel) ";")
									noMissionTextID: 'descHallEmpty
									maxPerStation: 1
									})
							</Action>
					
							<Action id="actionCommoditiesExchange">
								(scrShowScreen gScreen &dsRPGCommoditiesExchange; {
									checkMilitaryID: True
									})
							</Action>

							<Action id="actionDockServices">
								(rpgDockServices gPlayerShip {
									checkMilitaryID: True
									})
							</Action>

							<Action id="actionUndock" cancel="1">
								<Exit/>
							</Action>
						</Actions>
					</Default>
				</Panes>
			</Main>
		</DockScreens>
		
		<!-- Events and Data -->

		<StaticData>
			<NPCService>
				(	;	service					level	margin
					(	'repairArmor			5		100		)
					)
			</NPCService>
		</StaticData>

		<Events>
			<OnCreate>
				(sysAddObjRecurringTimerEvent 150 gSource "OnTrafficControl")
			</OnCreate>
			
			<OnContractGenerate>
				(intGenerateStandardRequestContract1)
			</OnContractGenerate>

			<OnContractQuery>True</OnContractQuery>

			<OnTrafficControl>
				(comTrafficControl gSource 10)
			</OnTrafficControl>
		</Events>
		
		<Language>
			<Text id="actionCommoditiesExchange">"[C]ommodities Exchange"</Text>
			<Text id="actionDockServices">"[D]ock Services"</Text>
			<Text id="actionMainHall">"[M]eeting Hall"</Text>
			<Text id="actionUndock">"[U]ndock"</Text>
			
			<Text id="descWelcome">
				(cat
					"You are in the docking bay of a Commonwealth colony. Except for a few shuttles, "
					"the docking bay of this station is deserted. A loose hose spills dirty "
					"water onto the landing pad; elsewhere, an automatic load-lifter moves forward "
					"and back again as it unloads a ship's cargo hold. The air smells of liquid fuel "
					"and exhaust."
					)
			</Text>
			<Text id="descHallEmpty">
				(cat
					"The meeting hall is busy with commercial activity; everyone goes about their business."
					)
			</Text>
		</Language>
	</StationType>

	<!-- Commonwealth Turret -->

	<StationType UNID="&stCommonwealthTurret;"
			name=				"Commonwealth defense turret"
			sovereign=			"&svCommonwealth;"
			abandonedScreen=	"&dsAbandonedStation;"
			dockScreen=			"Main"
			noMapLabel=			"true"
			noFriendlyFire=		"true"
			canAttack=			"true"

			mass=				"2000"
			armorID=			"&itP120HexphaseArmor;"
			hitPoints=			"100"
			structuralHitPoints="20"
			fireRateAdj=		"40"
			ejectaType=			"&vtWreckEjecta;"
			>

		<ImageVariants>
			<Image			imageID="&rsStations4;" imageX="96" imageY="320" imageWidth="32" imageHeight="32"/>
			<Image			imageID="&rsStations4;" imageX="96" imageY="352" imageWidth="32" imageHeight="32"/>
			<Image			imageID="&rsStations4;" imageX="96" imageY="384" imageWidth="32" imageHeight="32"/>
			<Image			imageID="&rsStations4;" imageX="96" imageY="416" imageWidth="32" imageHeight="32"/>
		</ImageVariants>

		<Devices>
			<Device deviceID="&itTeV9Blaster;"	omnidirectional="true"/>
		</Devices>

		<DockScreens>
			<Main>

				<Panes>
					<Default
							desc=	"You are docked at a Commonwealth Defense Turret. These armed and armored turrets are used to defend Commonwealth stations and settlements in the Ungoverned Territories beyond St. Katharine's Star.">

						<Actions>
							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>

					</Default>
				</Panes>
			</Main>
		</DockScreens>

		<DockingPorts
				portCount=		"2"
				portRadius=		"24"
				maxDist=		"3"
				/>

	</StationType>

	<!-- Commonwealth Colony, Armed -->

	<StationType UNID="&stCommonwealthColonyArmed;"
			name=				"armed Commonwealth colony"
			sovereign=			"&svCommonwealth;"
			inherit=			"&baCommonwealthStation;"
				 
			attributes=			"commonwealth, commonwealthCustoms, fleetDelivery, friendly, generic, human, majorStation, primary, populated"
				 
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"

			size=				"390"
			armorID=			"&itP120HexphaseArmor;"
			hitPoints=			"560"
			multiHull=			"true"
			regen=              "10"
			shipRegen=			"6"
				 
			canAttack=			"true"
			explosionType=		"&vtBlastExplosion3;"
			ejectaType=			"&vtWreckEjecta;"
			fireRateAdj=		"40"
			>

		<Names noArticle="true">Anvil Station; Brimstone Station; Cerberus Station;
				Demesne Colony; Exile Station; Farsend Station;
				Greenspace Colony; Hellas Station; Independence Station;
				Jotur Colony; C%1%0 Outpost; Lethe Colony; Mars Colony;
				Nebulon Colony; Oort Station; Purgatory Station; Quequeg Station;
				Rend Colony; Sangre Station; Tantalus Colony; Umber Station;
				Vindication Colony; Wight Station; %s Colony; %s Alpha Station;
				%s Beta Station; %s Gamma Station; %s Epsilon Station</Names>

		<!-- Encounter Info -->

		<Encounter
				levelFrequency=		"---uu cu--- ----- ----- -----"
				locationCriteria=	"+planetary"
				enemyExclusionRadius="60"
				/>

		<!-- Trade and Items -->

		<Trade currency="credit" max="50000" replenish="2500">
			<Sell	criteria="m +commonwealth; -premiumAmmo; -illegal; -notForSale; -notStandard;" priceAdj="115" inventoryAdj="200" levelFrequency="systemLevel:ruc|c|cur"/>
			<Sell	criteria="*NU -Illegal; -ID; -NotForSale;"	priceAdj="110"/>
			<Buy	criteria="amswNU -Illegal; -NotForSale;"		priceAdj="50"/>
			<Buy	criteria="*NU -Illegal; -ID; -NotForSale;"	priceAdj="90"/>
			<Buy	criteria="*NU -Illegal; -ID;"				priceAdj="10"/>
			
			<Refuel			criteria="f +BasicFuel; L:1-7;" priceAdj="93"/>
			<RepairArmor	criteria="a L:1-7;" priceAdj="100"/>
			<ReplaceArmor	criteria="a L:1-7;" priceAdj="100"/>
			<InstallDevice	criteria="d L:1-7;" priceAdj="100"/>
			<RemoveDevice	criteria="d L:1-7;" priceAdj="100"/>
		</Trade>

		<Items>
			<RandomItem	count="10" 
					criteria=		"ad L:1-7; -Illegal; -Military; -Alien; -Specialty; -NotStandard; -NotForSale;"
					levelFrequency=	"systemLevel:u|c|crv"
					/>
			<RandomItem count="10" 
					criteria=		"*~ad -Illegal; -Military; -Alien; -Specialty; -NotStandard; -NotForSale;"
					levelFrequency=	"systemLevel:ru|c|cur"
					/>
			<Item count="4d12"	item="&itXenotiteFuelRod;" />
		</Items>

		<!-- Configuration -->
		
		<Devices>
			<Device deviceID="&itTeV9Blaster;"	omnidirectional="true"/>
		</Devices>

		<!-- Satellites -->
		
		<Satellites overlapCheck="asteroids">
			<Orbitals distance="12" angle="45">
				<Station type="&stCommonwealthTurret;" imageVariant="2"/>
			</Orbitals>

			<Orbitals distance="12" angle="135">
				<Station type="&stCommonwealthTurret;" imageVariant="1"/>
			</Orbitals>

			<Orbitals distance="12" angle="225">
				<Station type="&stCommonwealthTurret;" imageVariant="0"/>
			</Orbitals>

			<Orbitals distance="12" angle="315">
				<Station type="&stCommonwealthTurret;" imageVariant="3"/>
			</Orbitals>
		</Satellites>
		
		<!-- Ships and Defenses -->
		
		<Ships>
			<Lookup count="2" table="&tbCommDefenders;"/>
			<Lookup count="1d4" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<Reinforcements minShips="5">
			<Table>
				<Lookup chance="75" table="&tbCommDefenders;"/>
				<Lookup chance="25" table="&tbCommPrivateCrafts;"/>
			</Table>
		</Reinforcements>

		<!-- Image and Effects -->
		
		<Image imageID="&rsCommonwealthArmoredColony;" imageWidth="320" imageHeight="290" viewportRatio="0.05"/>

		<DockingPorts
				portCount=		"10"
				portRadius=		"175"
				>
		</DockingPorts>
		
		<!-- Dock Screens -->
		
		<DockScreens>
			<Main>
				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDescTranslate gScreen 'descWelcome)
						</OnPaneInit>

						<Actions>
							<Action id="actionMainHall" default="1">
								(rpgMissionAssignment {
									missionCriteria: (cat "n +commonwealthColonyArmed; =" (sysGetLevel) ";")
									noMissionTextID: 'descHallEmpty
									maxPerStation: 1
									})
							</Action>
					
							<Action id="actionCommoditiesExchange">
								(scrShowScreen gScreen &dsRPGCommoditiesExchange; {
									checkMilitaryID: True
									})
							</Action>

							<Action id="actionDockServices">
								(rpgDockServices gPlayerShip {
									checkMilitaryID: True
									})
							</Action>

							<Action id="actionUndock" cancel="1">
								<Exit/>
							</Action>
						</Actions>
					</Default>
				</Panes>
			</Main>

		</DockScreens>
		
		<!-- Events and Data -->

		<StaticData>
			<NPCService>
				(	;	service					level	margin
					(	'repairArmor			7		100		)
					)
			</NPCService>
		</StaticData>

		<Events>
			<OnCreate>
				(sysAddObjRecurringTimerEvent 150 gSource "OnTrafficControl")
			</OnCreate>

			<OnContractGenerate>
				(intGenerateStandardRequestContract1)
			</OnContractGenerate>

			<OnContractQuery>True</OnContractQuery>

			<OnTrafficControl>
				(comTrafficControl gSource 10)
			</OnTrafficControl>
		</Events>
		
		<Language>
			<Text id="actionCommoditiesExchange">"[C]ommodities Exchange"</Text>
			<Text id="actionDockServices">"[D]ock Services"</Text>
			<Text id="actionMainHall">"[M]eeting Hall"</Text>
			<Text id="actionUndock">"[U]ndock"</Text>
			
			<Text id="descWelcome">
				(cat
					"You are in the docking bay of a Commonwealth colony. Except for a few shuttles, "
					"the docking bay of this station is deserted. A loose hose spills dirty "
					"water onto the landing pad; elsewhere, an automatic load-lifter moves forward "
					"and back again as it unloads a ship's cargo hold. The air smells of liquid fuel "
					"and exhaust."
					)
			</Text>
			<Text id="descHallEmpty">
				(cat
					"The meeting hall is busy with commercial activity; everyone goes about their business."
					)
			</Text>
		</Language>
	</StationType>

	<!-- Commonwealth Dry Dock -->

	<StationType UNID="&stCommonwealthDryDock;"
			name=				"Commonwealth dry dock"
			sovereign=			"&svCommonwealth;"
			inherit=			"&baCommonwealthStation;"
				 
			dockScreen=			"&dsDryDock;"
			abandonedScreen=	"&dsAbandonedStation;"
			canAttack=			"true"

			level=				"5"
			multiHull=			"true"
			armorID=			"&itPlasteelPlate;"
			hitPoints=			"800"
			regen=              "8"
			shipRegen=			"8"
			explosionType=		"&vtBlastExplosion3;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"commonwealth, commonwealthCustoms, fleetDelivery, friendly, generic, human, majorStation, populated"
			levelFrequency=		"uucuu r---- ----- ----- -----"
			unique=				"inSystem"
			locationCriteria=	"+planetary"
			enemyExclusionRadius="75"
			>

		<Image			imageID="&rsStations1;" imageX="256" imageY="0" imageWidth="224" imageHeight="224"/>

		<Trade currency="credit" max="50000" replenish="2500">
			<Sell	criteria="*NU -illegal; -ID; -notForSale;"	priceAdj="110"  noDescription="true"/>
			
			<Refuel			criteria="f +BasicFuel; L:1-7;" priceAdj="95"/>
			<RepairArmor	criteria="a L:1-8;" priceAdj="100"/>
			<ReplaceArmor	criteria="a L:1-8;" priceAdj="100"/>
			<InstallDevice	criteria="d L:1-7;" priceAdj="100"/>
			<RemoveDevice	criteria="d L:1-7;" priceAdj="100"/>
		</Trade>
		
		<Items>
			<RandomItem count="1d6" criteria="r -illegal; -military; -notForSale; -notStandard; L:3-7;"		levelFrequency="systemLevel:ru|c|curv"/>
		</Items>

		<Ships>
			<Lookup count="1d3" table="&tbCommDefenders;"/>
			<Lookup count="1d2" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<Reinforcements minShips="5">
			<Table>
				<Lookup chance="75" table="&tbCommDefenders;"/>
				<Lookup chance="25" table="&tbCommPrivateCrafts;"/>
			</Table>
		</Reinforcements>

		<StaticData>
			<NPCService>
				(	;	service					level	margin
					(	'repairArmor			8		100		)
					)
			</NPCService>
		</StaticData>

		<Events>
			<OnContractGenerate>
				(intGenerateIndustrialRequestContract1)
			</OnContractGenerate>

			<OnContractQuery>True</OnContractQuery>
		</Events>

		<DockingPorts>
			<Port x="0"		y="100" />
			<Port x="-80"	y="40" />
			<Port x="80"	y="40" />
			<Port x="-60"	y="-40" />
			<Port x="60"	y="-40" />

			<Port x="0"		y="-105" />
			<Port x="-130"	y="-17" />
			<Port x="130"	y="-17" />
			<Port x="-70"	y="105" />
			<Port x="70"	y="105" />
		</DockingPorts>
	</StationType>

	<!-- Commonwealth Medical Suburb -->

	<StationType UNID="&stMedicalSuburb;"
			name=				"Commonwealth medical colony"
			sovereign=			"&svCommonwealth;"
			inherit=			"&baCommonwealthStation;"
				 
			attributes=			"commonwealth, commonwealthCustoms, friendly, generic, human, populated"
				 
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"

			level=				"4"
			size=				"390"
			armorID=			"&itPlasteelPlate;"
			hitPoints=			"320"
			multiHull=			"true"
			regen=              "4"
			shipRegen=			"1"
				 
			canAttack=			"true"
			fireRateAdj=		"80"
			explosionType=		"&vtBlastExplosion2;"
			ejectaType=			"&vtWreckEjecta;"
			>

		<!-- Encounter Info -->

		<Encounter
				levelFrequency=		"uuurr ----- ----- ----- -----"
				locationCriteria=	"-outerSystem, +planetary"
				enemyExclusionRadius="50"
				/>

		<Names noArticle="true">
			Asclepius Station; Barnard Station; Station Charity; 
			Crick Station; Drew Station; Station Empathy; Freud Complex;
			Station Grace; Haeckel Station; Imhotep Station;
			Jung Center; Koch Station; Leeuwenhoek Station;
			Morton Station; Nicolle Station; Osler Station;
			Penfield Station; Station Respite; Salk Station;
			Taussig Station; Urbani Station; Virchow Station;
			Watson Station; Yegerov Station; Zygote Station;
			Cyteen Station; NeuroSci Station; Biogen Station;
			Pharmaton %s; Medecin d'Etoile Station
		</Names>

		<!-- Trade and Items -->
		
		<Trade currency="credit" max="50000" replenish="2500">
			<Sell	criteria="*NU +Meds; -Illegal; -ID; -NotForSale;"	priceAdj="100"/>
			<Buy	criteria="*NU +Food; -Illegal;"	priceAdj="110"/>
			<Buy	criteria="*NU +Lux; -Illegal;"	priceAdj="120"/>
		</Trade>

		<Items>
			<RandomItem count="10-20" 
					criteria=		"* +Meds; -Illegal; -Military; -Alien; -NotStandard; -NotForSale;"
					levelFrequency=	"systemLevel:ru|c|cur"
					/>
		</Items>

		<!-- Configuration -->
		
		<Devices>
			<Device deviceID="&itTeV9Blaster;"	omnidirectional="true"/>
		</Devices>

		<!-- Ships and Defenses -->
		
		<Ships>
			<Lookup count="2" table="&tbCommDefenders;"/>
			<Lookup count="1d4" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<Reinforcements minShips="5">
			<Table>
				<Lookup chance="75" table="&tbCommDefenders;"/>
				<Lookup chance="25" table="&tbCommPrivateCrafts;"/>
			</Table>
		</Reinforcements>

		<!-- Image and Effects -->

		<Image imageID="&rsCommonwealthMedicalColony;" imageWidth="320" imageHeight="290" viewportRatio="0.05"/>

		<DockingPorts
				portCount=		"10"
				portRadius=		"175"
				>
		</DockingPorts>

		<!-- Dock Screens -->
		
		<DockScreens>
			<Main>
				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"You are in the docking bay of " (objGetName gSource) ". Medical professionals live and work on this station, doing everything from research, to drug manufacturing, to remote medicine."
								))
						</OnPaneInit>

						<Actions>
							<Action name="Commodities Exchange" default="1" key="C">
								(scrShowScreen gScreen &dsRPGCommoditiesExchange; {
									checkMilitaryID: True
									})
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>

					</Default>
				</Panes>
			</Main>
		</DockScreens>
		
		<!-- Events and Data -->
		
		<Events>
			<OnContractGenerate>
				(intGenerateStandardRequestContract1)
			</OnContractGenerate>

			<OnContractQuery>True</OnContractQuery>
		</Events>

        <Language>
            <Text id="core.mapDesc">"Sells meds &mdash; Buys food and luxuries"</Text>
        </Language>
	</StationType>

	<!-- Commonwealth Residentials -->

	<StationType UNID="&stCommonwealthResidentials;"
			name=				": Commonwealth residentials|Commonwealth residentials"
			sovereign=			"&svCommonwealth;"
			inherit=			"&baCommonwealthStation;"
				 
			attributes=			"commonwealth, commonwealthCustoms, friendly, generic, human, populated"
				 
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"

			level=				"4"
			size=				"390"
			armorID=			"&itPlasteelPlate;"
			hitPoints=			"320"
			multiHull=			"true"
			regen=              "6"
				 
			canAttack=			"true"
			explosionType=		"&vtBlastExplosion2;"
			ejectaType=			"&vtWreckEjecta;"
			>
		
		<!-- Ships and Defenses -->

		<Ships>
			<Lookup table="&tbCommDefenders;"/>
			<Lookup count="1d4+1" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<!-- Image and Effects -->
		
		<Image imageID="&rsCommonwealthResidentials;" imageWidth="320" imageHeight="290" viewportRatio="0.05"/>

		<DockingPorts
				portCount=		"10"
				portRadius=		"175"
				>
		</DockingPorts>
		
		<!-- Dock Screens -->
		
		<DockScreens>
			<Main>
				<Panes>
					<Default
							desc=	"Welcome to Commonwealth Residentials.">

						<Actions>
							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</Default>
				</Panes>
			</Main>
		</DockScreens>

		<!-- Events and Data -->
		
		<Events>
			<OnContractGenerate>
				(intGenerateStandardRequestContract1)
			</OnContractGenerate>

			<OnContractQuery>True</OnContractQuery>
		</Events>			
	</StationType>
	
	<!-- Mission: Destroy Threat to Commonwealth Habitat
	
	EXTRA DATA
	
	reward:				Reward (in credits) for completing mission
	targetID:			Id of station to destroy
	targetType:			One of:
							'centauriWarlords
							'miscEnemy

	-->
	
	<MissionType UNID="&msDestroyThreatToSlums;"
			name=				"Destroy Threat to Commonwealth Habitat"
			attributes=			"commonwealth, commonwealthHabitat"

			level=				"1-4"
			scope=				"system"

			>
		<Events>
			<OnCreate>
				; Called when mission object is created. This adds the mission
				; to the list of available missions, but it does not necessarily
				; start the mission.
				;
				; The script may call msnDestroy to abort creation of the mission.
				;
				; gSource is mission object
				; gData is arbitrary data passed in to msnCreate
				; aOwnerObj is the object that created the mission (or nil)
				
				(block (enemyStations)
				
					(switch
					
						; Get a list of enemy stations in the region. If we cannot find any
						; suitable targets then we don't have a mission.
						
						(not (setq enemyStations (sysFindObject aOwnerObj "TAE +populated; -uncharted; N:450;")))
							(msnDestroy gSource)
							
						; Otherwise we can create a mission
						
						(block (targetObj)
						
							; Pick a random enemy station to destroy
							(setq targetObj (seededRandom (objGetDestiny aOwnerObj) enemyStations))
							
							; Remember it
							(msnSetData gSource 'targetID (objGetID targetObj))
							
							; Register for events so we know when the target is destroyed
							(msnRegisterForEvents gSource targetObj)

							; Remember the type of enemy
							(switch
								(objHasAttribute targetObj "centauriWarlords")
									(msnSetData gSource 'targetType 'centauriWarlords)
									
								(msnSetData gSource 'targetType 'miscEnemy)
								)
								
							; Compute reward
							(msnSetData gSource 'reward (add 200 (multiply (objGetLevel targetObj) 100)))
							)
						)
					)
			</OnCreate>

			<OnAccepted>
				; Called if the player accepts the mission. The mission is 
				; already running (OnStarted has been called).
				;
				; gSource is mission object

			</OnAccepted>
			
			<OnDeclined>
				; Called if the player rejects the mission. The mission is already
				; running (OnStarted has been called).
				;
				; gSource is mission object.

			</OnDeclined>

			<OnStarted>
				; Called when the mission starts. This is called if the mission
				; starts running (either because the player accepted or some other
				; reason).
				;
				; gSource is mission object.

			</OnStarted>
			
			<OnSetPlayerTarget>
				; Called to refresh the player's target. Always called right after
				; the player accepts the mission. May be called at other times
				; (e.g., after the player returns to the system).
				;
				; gSource is mission object
				; aReason is:
				;		'accepted: Mission has been accepted
				;		'debriefed: Player has been debriefed
				;		'failure: Mission failed
				;		'inProgress: Player visited station while mission in progress
				;		'newSystem: Player is in a new system
				;		'success: Mission completed successfully
				
				(block (targetObj)
					(switch
						; If we just got debriefed then we clear our targets.

						(eq aReason 'debriefed)
							(shpCancelOrders gPlayerShip)

						; If the mission is complete, then we point towards the 
						; owner station.

						(msnGetProperty gSource 'isCompleted)
							(if (setq targetObj (objGetObjByID (msnGetProperty gSource 'ownerID)))
								(block Nil
									(shpCancelOrders gPlayerShip)
									(shpOrder gPlayerShip 'dock targetObj)
									)
								)

						; Otherwise, we point towards the target

						(if (setq targetObj (objGetObjByID (msnGetData gSource 'targetID)))
							(block Nil
								(shpCancelOrders gPlayerShip)
								(shpOrder gPlayerShip 'attack targetObj)
								)
							)
						)
					)
			</OnSetPlayerTarget>
			
			<OnObjDestroyed>
				(switch
					(eq (objGetID aObjDestroyed) (msnGetData gSource 'targetID))
						(msnSuccess gSource)
					)
			</OnObjDestroyed>
			
			<OnCompleted>
				; Called when the mission ends (generally because msnSuccess or
				; msnFailure were called).
				;
				; gSource is mission object
				; gData is arbitrary data passed in to msnSuccess or msnFailure
				; aReason is:
				;		'failure: Mission failed
				;		'success: Mission completed successfully
				
			</OnCompleted>
			
			<OnReward>
				; Called by msnReward, generally during debrief.
				;
				; gSource is mission object
				; gData is data passed to msnReward

				(intMissionRewardPayment (msnGetData gSource 'reward))
			</OnReward>
			
			<OnDestroy>
				; Called when mission object is destroyed (after mission ends)
				;
				; gSource is mission object
				;
				; NOTE: No need to unregister for events because we automatically
				; unregister when the mission is complete.

			</OnDestroy>
		</Events>
		
		<Language>
			<Text id="Name">
				"Destroy Threat to Commonwealth Habitat"
			</Text>
			<Text id="Summary">
				(cat
					"Your mission is to destroy " (objGetName (objGetObjByID (msnGetData gSource 'targetID)) 0x04) " in the " (sysGetName) " system.\n\n"
					"System: " (sysGetName) "\n"
					"Payment: " (msnGetData gSource 'reward) " credits"
					)
			</Text>
			<Text id="Intro">
				(cat
					"The station master stands at his console. Managers and supervisors swarm around him dealing with various crises. "
					"He turns his attention towards you:\n\n"
					"\"We could use your help, %brother%. "
					"You've got a ship with a good punch and we got something that needs punching. We'll pay you, of course.\""
					)
			</Text>
			<Text id="Briefing">
				(block (
					(targetObj (objGetObjByID (msnGetData gSource 'targetID)))
					)

					(switch
						(eq (msnGetData gSource 'targetType) 'centauriWarlords)
							(cat
								"\"A band of Centauri warlords has been harassing this station recently. We've discovered the location of their base and we want you to go there and destroy them. "
								"If you succeed we'll pay you " (msnGetData gSource 'reward) " credits. Will you help us?\""
								)
							
						(cat
							"\"" (objGetName targetObj 0x05) " nearby has been attacking us recently. We want you to destroy them! "
							"If you succeed we'll pay you " (msnGetData gSource 'reward) " credits. Will you help us?\""
							)
						)
					)
			</Text>
			<Text id="AcceptReply">
				"\"Thank you! I knew we could count on you. We'll program the target into your ship's computer. Just follow the arrow on your screen and you'll get there. Good luck!\""
			</Text>
			<Text id="DeclineReply">
				"\"Ah, Hell! What are you doing here then? Stop wasting my time!\""
			</Text>
			<Text id="InProgress">
				"\"What's wrong? You said you could handle this mission! Get back out there and finish the job!\""
			</Text>
			<Text id="SuccessDebrief">
				(cat
					(switch
						(eq (msnGetData gSource 'targetType) 'centauriWarlords)
							"\"Great work! Maybe the warlords will think twice before attacking us again."

						"\"Great work! Now we can live in peace. "
						)
					" We've deposited " (msnGetData gSource 'reward) " credits to your account.\""
					)
			</Text>
			<Text id="SuccessMsg">
				"Mission complete!"
			</Text>
			<Text id="AlreadyDebriefed">
				"\"Welcome back! Thanks for the great work last time.\""
			</Text>
			<Text id="Unavailable">
				"\"Sorry, there are no missions available.\""
			</Text>
		</Language>
	</MissionType>

	<!-- Commonwealth Slums

	GLOBAL DATA

	lastMissionTime:	Tick on which mission was given to player (Nil if never)
	totalMissionCount:	Total number of missions that the player has requested
	missionsCompleted:	Total number of successful missions
	missionsFailed:		Total number of failures

	-->

	<StationType UNID="&stCommonwealthSlums;"
			name=				"Commonwealth habitat"
			sovereign=			"&svCommonwealth;"
			inherit=			"&baCommonwealthStation;"
				 
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			canAttack=			"true"

			level=				"3"
			multiHull=			"true"
			armorID=			"&itPlasteelPlate;"
			hitPoints=			"150"
			regen=              "1"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"commonwealth, commonwealthCustoms, friendly, generic, human, populated"
			>

		<Names noArticle="true">Habitat Alpha %1%0; Habitat Beta %1%0; Habitat Gamma %1%0; Habitat Delta %1%0;
				Habitat Epsilon %1%0; Habitat Zeta %1%0</Names>

		<ImageVariants>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="0" imageY="0" imageWidth="64" imageHeight="128"/>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="64" imageY="0" imageWidth="64" imageHeight="128"/>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="128" imageY="0" imageWidth="64" imageHeight="128"/>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="192" imageY="0" imageWidth="64" imageHeight="128"/>
		</ImageVariants>

		<Ships>
			<Lookup count="1d4" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<StaticData>
			<Rumors>
				(
					"\"You got a pretty nice ship there. Did your mom and dad buy it for you?\""
					"\"Truth is, you gotta approach life philosophically, you know what I mean? You gotta believe that it's all going to work out in the end, or else what's the point?\""
					"\"Nobody cares. Station needs a carbon scrubber? Get on the waiting list! After the corporate suits get their grilled Icelandic salmon, then they might pay attention to you. Nobody cares.\""
					(if (eq (objGetProperty gPlayerShip 'characterClass) &unidPilgrimClass;)
						"\"I don't know what you're doing in this backwater system. You wanna get to the Core? Go! What's stopping you? Kids today: they dream big, but they'd rather watch the 3DVs.\""
						"\"I don't know what you're doing in this backwater system. You wanna see the galaxy? Go! What's stopping you? Kids today: they dream big, but they'd rather watch the 3DVs.\""
						)
					"\"A station is not like a starship. If you get into trouble you can always run away. All we can do is sit tight and repair the damage. Takes a special kind of man to live like that.\""
					(cat "\"How do you like your " (objGetName gPlayerShip 0x00) "? "
						(switch 
							(eq (objGetType gPlayerShip) &scSapphirePlayer;)
								"My daughter's friend had one once. It was beautiful, but not very practical for long voyages.\""
							(eq (objGetType gPlayerShip) &scEI100XPlayer;)
								"My son pilots an older 200-series in the Cairn system. He's got it up-armored with polyceramic to protect against pirate attacks.\""
							(eq (objGetType gPlayerShip) &scWolfenPlayer;)
								"I knew this guy John Tremaine who flew one in the Militia. They're fast as hell on a whip, but a little flimsy. Hope you've got some good shields on her.\""
							"I haven't seen a lot of ships like that. Is it hard to get parts for it?\""
							)
						)
					)
			</Rumors>

			<RumorsSE>
				(
					"\"You got a pretty nice ship there. Did your mom and dad buy it for you?\""
					"\"Truth is, you gotta approach life philosophically, you know what I mean? You gotta believe that it's all going to work out in the end, or else what's the point?\""
					"\"Nobody cares. Station needs a carbon scrubber? Get on the waiting list! After the corporate suits get their grilled Icelandic salmon, then they might pay attention to you. Nobody cares.\""
					(if (not (eq (typGetGlobalData &scArcoVaughnHeavyRaider; "status") 'destroyed))
						"\"The warlords are annoying, but they don't mean much. The only one that bothers me is Arco Vaughn. He's trouble. Someone ought to air him out before things get out of hand, you know?\""
						"\"Thank heavens that someone finally killed Arco Vaughn. Maybe now the warlords will leave us alone.\""
						)
					"\"I don't know what you're doing in this backwater system. You wanna get to the Core? Go! What's stopping you? Kids today: they dream big, but they'd rather watch the 3DVs.\""
					(if (not (eq (typGetGlobalData &scArcoVaughnHeavyRaider; "status") 'destroyed))
						"\"It's sad about Raisu station, isn't it? If a corporate fuel station got taken over by Centauri warlords they'd have Admiral Decker himself leading the rescue. But no one cares about a poor, backwater station, I guess.\""
						"\"It's shame what Raisu station had to go through, isn't it? If a corporate station had been occupied by warlords, they'd have sent Admiral Decker himself to lead the rescue. But no one cares about a poor, backwater station, I guess.\""
						)
					(if (not (eq (typGetGlobalData &scArcoVaughnHeavyRaider; "status") 'destroyed))
						"\"If you're looking for Arco Vaughn, go to Raisu station: the station master there will help you out. But first you gotta convince her that you're serious.\""
						"\"I hear that Arco Vaughn is finally dead. No one will mourn him. I really feel for Erica and her team at Raisu\x97they went through hell.\""
						)
					(if (not (eq (typGetGlobalData &scArcoVaughnHeavyRaider; "status") 'destroyed))
						"\"If you need help against Arco Vaughn the station master at Raisu station will help you. But you'll have to prove that you're serious. Take out a few Centauri stations and you might convince her.\""
						"\"We're all glad that Arco Vaughn is dead. I heard someone from Raisu station finally had enough and decided to chase him down."\""
						)
					)
			</RumorsSE>

			<RumorsBA>
				(
					(cat "\"What's your favorite weapon? Personally I favor "
						(seededRandom (objGetDestiny gSource)
							'(
								"the AK505 Ballista. It's a monster and it will kill a lot of ships with a single punch. When I hit something, I want it to go down, you know what I mean?\""
								"a particle beam weapon. The latest tech is always going to win in the end. You have to keep up with technology or you're just another wreck in the Arena.\""
								"an omni turbolaser. I say a computer can hit a target way better than I can, so why not take advantage of that? By the time your opponent has lined up his BFG, you've already hit him five times!\""
								"a slam cannon, enhanced if possible. There's nothing better than the thump-thump sounds of a slam cannon hitting your enemy's plasteel!\""
								"the RK15 Partisan turret. Sure, the wimpy omniturbo is a little faster, but I wanna hit my targets with a punch, not shine a damn light in their eyes.\""
								)
							)
						)
					(cat "\"So what kind of shields you got? I think a lot of gladiators underestimate how important shields are. "
						(seededRandom (objGetDestiny gSource)
							'(
								"Even a good monopole deflector is better than nothing. I'd enhance the crap out of it, though.\""
								"The Cyclotron series are my choice at the moment. The S55 has more protection than a class III; better yet, get the S1200.\""
								"If you can afford the Ceratops series then go for it. They're the best against missiles anyway, which is what you're gonna get hit with in the Arena.\""
								)
							)
						)
					)
			</RumorsBA>
		</StaticData>

		<Events>
			<GetGlobalAchievements>
				(block (theList)
					(if (gr (typGetGlobalData &stCommonwealthSlums; 'totalMissionCount) 0)
						(setq theList (list
							(list
								"Commonwealth habitat missions"
								(intMissionAchievementString (typGetGlobalData &stCommonwealthSlums; 'missionsCompleted) (typGetGlobalData &stCommonwealthSlums; 'missionsFailed))
								"missions &amp; activities"
								)
							))
						)
						
					theList
					)
			</GetGlobalAchievements>

			<OnContractGenerate>
				(intGenerateStandardRequestContract1)
			</OnContractGenerate>

			<OnContractQuery>True</OnContractQuery>

			<OnMissionAccepted>
				(typIncGlobalData &stCommonwealthSlums; 'totalMissionCount)
			</OnMissionAccepted>

			<OnMissionCompleted>
				(if (msnGetProperty aMissionObj 'isActive)
					(if (eq aReason 'success)
						(typIncGlobalData &stCommonwealthSlums; 'missionsCompleted)
						(typIncGlobalData &stCommonwealthSlums; 'missionsFailed)
						)
					)
			</OnMissionCompleted>
		</Events>

		<DockScreens>
			<Main>
				<Panes>
					<Default>

						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"The loud voices of a packed multitude bounce off every bulkhead and corridor in the station. "
								"Old air scrubbers pump a thin, odorous breeze out of rusty vents. Discarded packets of Salmonite and Red Nebula beer huddle in the corner.\n\n"
								"Welcome to " (objGetName gSource) "!"
								))
						</OnPaneInit>

						<Actions>
							<Action name="Meeting Hall" key="M" default="1">
								(block (lastMissionTime missionInterval theMission)
									; Figure out the last time that a habitat gave out a mission
									(setq lastMissionTime (objGetGlobalData gSource "lastMissionTime"))

									; Time between missions (5400-8990 or 3-5 real minutes)
									(setq missionInterval (add 5400 (multiply (objGetDestiny gSource) 10)))

									(switch
										; If we have an active mission, then show it
										(setq theMission (@ (msnFind gSource "aS") 0))
											(scrShowScreen gScreen &dsRPGMission;
												{
												missionObj: theMission
												})

										; If the player has an active mission from some other station, then
										; no new mission

										(msnFind Nil "a +commonwealthHabitat;")
											(scrShowPane gScreen "Rumors")

										; If its not time for a new mission, then rumors
										(and lastMissionTime
												(gr (add lastMissionTime missionInterval) (unvGetTick)))
											(scrShowPane gScreen "Rumors")

										; If we've already gotten six missions, then no more missions
										(geq (objGetGlobalData gSource "totalMissionCount") 6)
											(scrShowPane gScreen "Rumors")

										; If we have an open mission or if we can create a mission then
										; show it.
										(or (setq theMission (@ (msnFind gSource "oS") 0))
												(setq theMission (msnCreate (typFind "n +commonwealthHabitat;") gSource)))
											(block Nil
												(objSetGlobalData gSource "lastMissionTime" (unvGetTick))
												(scrShowScreen gScreen &dsRPGMission;
													{
													missionObj: theMission
													})
												)

										; Otherwise, just rumors
										(scrShowPane gScreen "Rumors")
										)
									)
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>

					</Default>

					<Rumors>
						<OnPaneInit>
							(block (rumorTable)
								(switch
									(eq (sysGetNode) 'SE)
										(setq rumorTable "RumorsSE")

									(eq (sysGetNode) 'BA)
										(setq rumorTable "RumorsBA")

									(setq rumorTable "Rumors")
									)

								(scrSetDesc gScreen
									(cat "The station master is working at his console. He stops to chat:\n\n"
										(eval (intRandomMessage gSource rumorTable))
										)
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" key="C" default="1" cancel="1">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</Rumors>
				</Panes>
			</Main>

		</DockScreens>

		<DockingPorts>
			<Port x="0"		y="80" />
			<Port x="43"	y="56" />
			<Port x="52"	y="8" />
			<Port x="35"	y="-44" />
			<Port x="-35"	y="-44" />
			
			<Port x="-52"	y="8" />
			<Port x="-43"	y="56" />
		</DockingPorts>

	</StationType>

	<!-- Container Habitat

	GLOBAL DATA

	donationPoints:		Donation points earned

	-->

	<StationType UNID="&stContainerHabitat;"
			name=				"container habitat"
			sovereign=			"&svCommonwealth;"
			inherit=			"&baCommonwealthStation;"
				 
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			canAttack=			"true"

			level=				"4"
			multiHull=			"true"
			armorID=			"&itPlasteelPlate;"
			hitPoints=			"160"
			regen=              "1"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"commonwealth, friendly, generic, human, populated"
			levelFrequency=		"uur-- ----- ----- ----- -----"
			locationCriteria=	"-planetary"
			>

		<ImageVariants>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="0" imageY="128" imageWidth="64" imageHeight="64"/>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="64" imageY="128" imageWidth="64" imageHeight="64"/>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="128" imageY="128" imageWidth="64" imageHeight="64"/>
			<Image	imageID="&rsCommonwealthSlumsImage;" imageX="192" imageY="128" imageWidth="64" imageHeight="64"/>
		</ImageVariants>

		<Ships>
			<Lookup count="1d2-1" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<Trade currency="credit" max="50000" replenish="2500">
			<AcceptDonation	criteria="*"					priceAdj="100"/>
		</Trade>

		<StaticData>
			<DonationTable>
				; donate =	If -1, gain 1 donation point per item donated
				;			If 0, gain no donation points
				;			If greater than 0, this is the credit value to gain 1 donation point

				(	; pattern				donate	result
					("* +Meds;"				50		'info)
					("* +Illegal;"			250		'info)
					("* +Lux;"				100		'info)
					("* +Food;"				50		'info)
					("f"					50		'info)
					(Nil					0		'thanksForNothing)
					)
			</DonationTable>

			<Rumors>
				(
					"\"The Charon pirates are a menace. They have bases in almost every system and they prey on defenseless freighters.\""
					"\"If you need a contact in the Black Market find the Aleksany brothers; they're always doing business in some fancy hotel.\""
					"\"The anarchists don't bother us, but they really annoy the Corporations: they're always stealing their fancy ROMs.\""
					"\"Stay away from the Abbasid fortresses. Those fanatics will shoot you rather than let you get close.\""
					"\"The Urak warlords are another nutty group, but their armor and weapons are pretty good.\""
					"\"Hiro is the best hacker in the 'verse. He's created some fancy ROMs that even the cyber corporations can't figure out.\""
					)
			</Rumors>

			<RumorsSE>
				(
					"\"Watch out for Arco Vaughn. He is the most dangerous Centauri warlord; his heavy raider is protected against lasers and recoilless cannons. Avoid him if you want to live.\""
					"\"Arco Vaughn flies an enhanced heavy raider. His armor is protected against normal weapons; you'll need missiles to kill him.\""
					"\"Raisu Station is in trouble. The Centauri warlords have taken it over; don't go there unless you are armed and ready.\""
					"\"If you want to find Arco Vaughn, go to Raisu Station. Talk to the station master there. She will help you.\""
					"\"The Centauri warlords have many bases among the outer asteroids of Eridani; but if you go there, watch out: Arco Vaughn is there too.\""
					)
			</RumorsSE>

			<RumorsBA>
				(
					"\"The Slicer is the champion of the Arena! No one has been able to defeat him.\""
					"\"I don't watch the Arena games anymore; the Black Market has totally infiltrated the show and all the fights are rigged now.\""
					"\"I remember watching Kate Morgental fight in the Arena. She put on a great show! I don't know what happened to her; probably working for her father now.\""
					"\"Let me tell you a secret about fighting in the Arena: load up with missiles. Who cares about beams and whatnot; a good missile will cut through armor like a knife through Salmonite!\""
					)
			</RumorsBA>
		</StaticData>

		<Events>
			<OnContractGenerate>
				(intGenerateStandardRequestContract1)
			</OnContractGenerate>

			<OnContractQuery>True</OnContractQuery>

			<OnObjDestroyed>
				(if (eq aObjDestroyed (objGetObjRefData gSource "target"))
					(block Nil
						(shpCancelOrders gPlayerShip)
						(objUnregisterForEvents gSource aObjDestroyed)
						(objSetData gSource "missionID" Nil)
						)
					)
			</OnObjDestroyed>

			<OnObjDocked>
				(if (eq aDockTarget (objGetObjRefData gSource "target"))
					(block Nil
						(shpCancelOrders gPlayerShip)
						(objUnregisterForEvents gSource gPlayerShip)
						(objSetData gSource "missionID" Nil)
						)
					)
			</OnObjDocked>

			<OrderDestroyTarget>
				; aTargetObj = object to destroy
				
				(block Nil
					; Clean up in case we have a previous mission
					(if (eq (objGetData gSource "missionID") 'dockWithTarget)
						(objUnregisterForEvents gSource gPlayerShip)
						)

					(objSetData gSource "missionID" 'destroyTarget)
					(objSetObjRefData gSource "target" aTargetObj)
					(objRegisterForEvents gSource aTargetObj)

					(shpCancelOrders gPlayerShip)
					(shpOrder gPlayerShip 'attack aTargetObj)
					)
			</OrderDestroyTarget>

			<OrderDockWithTarget>
				(block Nil
					; Clean up in case we have a previous mission
					(if (eq (objGetData gSource "missionID") 'destroyTarget)
						(objUnregisterForEvents gSource (objGetObjRefData gSource "target"))
						)

					(objSetData gSource "missionID" 'dockWithTarget)
					(objSetObjRefData gSource "target" aTargetObj)
					(objRegisterForEvents gSource gPlayerShip)

					(shpCancelOrders gPlayerShip)
					(shpOrder gPlayerShip 'dock aTargetObj)
					)
			</OrderDockWithTarget>
		</Events>

		<DockScreens>
			<Main>
				<Panes>
					<Default>
						<OnPaneInit>
							(switch
								(eq (objGetProperty gPlayerShip 'characterClass) &unidPilgrimClass;)
									(scrSetDesc gScreen (typTranslate &stContainerHabitat; 'WelcomePilgrim))
									
								(scrSetDesc gScreen (typTranslate &stContainerHabitat; 'Welcome))
								)
						</OnPaneInit>

						<Actions>
							<Action name="Donate Item" key="D" default="1">
								(block Nil
									(setq gPrevScreen "Main")
									(setq gPrevPane "Default")
									(scrShowScreen gScreen "&dsContainerHabitatDonateItem;")
									)
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>

					</Default>
				</Panes>
			</Main>

		</DockScreens>

		<DockingPorts>
			<Port x="0"		y="70" />
			<Port x="61"	y="35" />
			<Port x="61"	y="-35" />
			<Port x="0"		y="-70" />
			<Port x="-61"	y="-35" />
			
			<Port x="-61"	y="35" />
		</DockingPorts>
		
		<Language>
			<Text id="Welcome">
				(cat
					"You are docked at a habitat made out of shipping containers. Children bounce off the bulkheads in zero-G while "
					"maintenance workers repair leaky seals and balky machinery. The station master approaches you:\n\n"
					
					"\"Traveling the universe, yeah? Why don't you spare some items for us!\""
					)
			</Text>
			<Text id="WelcomePilgrim">
				(cat
					"You are docked at a habitat made out of shipping containers. Children bounce off the bulkheads in zero-G while "
					"maintenance workers repair leaky seals and balky machinery. The station master approaches you:\n\n"
					
					"\"We don't get many pilgrims visiting around here. Why don't you give us some of your worldly possessions; "
					"they won't do you much good at the Core, or wherever you're trying to get.\""
					)
			</Text>
		</Language>

	</StationType>

	<!-- Commonwealth Settlement -->

	<StationType UNID="&stCommonwealthSettlement;"
			name=				"Commonwealth settlement"
			sovereign=			"&svCommonwealth;"
			inherit=			"&baCommonwealthStation;"
				 
			attributes=			"commonwealth, commonwealthCustoms, fleetDelivery, friendly, generic, human, populated"
				 
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			
			size=				"390"
			armorID=			"&itP120HexphaseArmor;"
			hitPoints=			"950"
			multiHull=			"true"
			regen=              "20"
			shipRegen=			"4"
				 
			canAttack=			"true"
			explosionType=		"&vtThermoExplosion2;"
			ejectaType=			"&vtWreckEjecta;"
			fireRateAdj=		"40"
			>

		<Names noArticle="true">Commonwealth Settlement %1%0%0%0</Names>

		<!-- Encounter Info -->

		<Encounter
				levelFrequency=		"----- -ucr- ----- ----- -----"
				locationCriteria=	"+planetary"
				enemyExclusionRadius="50"
				/>

		<!-- Trade and Items -->
		
		<Trade currency="credit" max="50000" replenish="2500">
			<Sell	criteria="m +commonwealth; -premiumAmmo; -illegal; -notForSale; -notStandard;" priceAdj="115" inventoryAdj="200" levelFrequency="systemLevel:ruc|c|cur"/>
			<Sell	criteria="*NU -Illegal; -ID; -NotForSale;"	priceAdj="110"/>
			<Buy	criteria="amswNU -Illegal; -NotForSale;"		priceAdj="50"/>
			<Buy	criteria="*NU -Illegal; -ID; -NotForSale;"	priceAdj="90"/>
			<Buy	criteria="*NU -Illegal; -ID;"				priceAdj="10"/>
			
			<Refuel			criteria="f +BasicFuel; L:1-8;" priceAdj="94"/>
			<RepairArmor	criteria="a L:1-8;" priceAdj="100"/>
			<ReplaceArmor	criteria="a L:1-8;" priceAdj="100"/>
			<InstallDevice	criteria="d L:1-8;" priceAdj="100"/>
			<RemoveDevice	criteria="d L:1-8;" priceAdj="100"/>
		</Trade>

		<Items>
			<RandomItem count="10" 
					criteria=		"ad L:1-8; -Illegal; -Military; -Alien; -Specialty; -NotStandard; -NotForSale;"
					levelFrequency=	"systemLevel:u|c|crv"
					/>
			<RandomItem count="10" 
					criteria=		"*~ad -Illegal; -Military; -Alien; -Specialty; -NotStandard; -NotForSale;"
					levelFrequency=	"systemLevel:ru|c|cur"
					/>

			<Item count="4d12"	item="&itPteracniumFuelRod;" />
		</Items>

		<!-- Configuration -->
		
		<Devices>
			<Device deviceID="&itTeV9Blaster;"	omnidirectional="true"/>
		</Devices>

		<!-- Satellites -->
		
		<Satellites overlapCheck="asteroids">
			<Orbitals distance="12" angle="45">
				<Station type="&stCommonwealthTurret;" imageVariant="2"/>
			</Orbitals>

			<Orbitals distance="12" angle="135">
				<Station type="&stCommonwealthTurret;" imageVariant="1"/>
			</Orbitals>

			<Orbitals distance="12" angle="225">
				<Station type="&stCommonwealthTurret;" imageVariant="0"/>
			</Orbitals>

			<Orbitals distance="12" angle="315">
				<Station type="&stCommonwealthTurret;" imageVariant="3"/>
			</Orbitals>
		</Satellites>

		<!-- Ships and Defenses -->
		
		<Ships>
			<Lookup count="2" table="&tbCommDefenders;"/>
			<Lookup count="1d4" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<Reinforcements minShips="5">
			<Table>
				<Lookup chance="75" table="&tbCommDefenders;"/>
				<Lookup chance="25" table="&tbCommPrivateCrafts;"/>
			</Table>
		</Reinforcements>

		<!-- Image and Effects -->
		
		<Image imageID="&rsCommonwealthSettlement;" imageWidth="320" imageHeight="290" viewportRatio="0.05"/>

		<DockingPorts
				portCount=		"10"
				portRadius=		"175"
				>
		</DockingPorts>
		
		<!-- Dock Screens -->
		
		<DockScreens>
			<Main>
				<Panes>
					<Default
							desc=	"You are in the docking bay of a Commonwealth settlement. Except for a few shuttles, the docking bay of this station is deserted. A loose hose is spilling dirty water onto the landing pad; elsewhere, an automatic load-lifter moves forward and back again as it unloads a ship's cargo hold. The air smells of liquid fuel and exhaust.">

						<Actions>
							<Action name="Commodities Exchange" default="1" key="C">
								(scrShowScreen gScreen &dsRPGCommoditiesExchange; {
									checkMilitaryID: True
									})
							</Action>

							<Action name="Dock Services" key="D">
								(rpgDockServices gPlayerShip {
									checkMilitaryID: True
									})
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>

					</Default>
				</Panes>
			</Main>

		</DockScreens>
		
		<!-- Events and Data -->

		<StaticData>
			<NPCService>
				(	;	service					level	margin
					(	'repairArmor			8		100		)
					)
			</NPCService>
		</StaticData>

		<Events>
			<OnContractGenerate>
				(intGenerateStandardRequestContract1)
			</OnContractGenerate>

			<OnContractQuery>True</OnContractQuery>
		</Events>
	</StationType>

	<!-- NavSign

		INITIAL DATA

		At create time we expect the following data to be initialized:

		Info:	A full description revealed if the player docks
		Sign:	The text of the sign.
	
	 -->

	<StationType UNID="&stCommonwealthNavSign;"
			name=				"(navigational beacon)"
			sovereign=			"&svIndependent;"
			dockScreen=			"&dsNavSign;"
			abandonedScreen=	"&dsAbandonedNavSign;"
			noMapLabel=			"true"

			mass=				"5000"
			armorID=			"&itUltraLightTitaniumArmor;"
			hitPoints=			"20"
			>

		<Image imageID="&rsStations1;" imageX="0" imageY="668" imageWidth="128" imageHeight="64"/>

		<DockingPorts>
			<Port x="-80"		y="0" />
		</DockingPorts>

		<Events>
			<OnCreate>
				(block (theID xOffset yOffset)

					; These offsets control the position of the text relative to
					; the center of the sign (Cartessian coordinates)

					(setq xOffset 6)
					(setq yOffset 19)

					; Create an effect for the sign.

					(setq theID 
						(objAddOverlay gSource &ovNavSignText; (sysVectorPixelOffset gSource xOffset yOffset) 0)
						)

					; Set the text of the sign

					(objSetOverlayEffectProperty gSource theID 'text (objGetData gSource "Sign"))
					)
			</OnCreate>

			<OnDestroy>
				; Remove all overlays
				(enum (objGetOverlays gSource) theID
					(objRemoveOverlay gSource theID)
					)
			</OnDestroy>
		</Events>
	</StationType>

	<OverlayType UNID="&ovNavSignText;"
            attributes=         "effect"
            >
		<Effect>
			<Text text="Nav Sign"
					font="SmallBold"
					primaryColor="0xc4, 0xdf, 0x9b"
					/>
		</Effect>
	</OverlayType>

	<Globals>
		(block Nil
			(setq comSealedContainerHack (lambda ()
				; If we went to trial for having a sealed container, then set a flag so
				; that the container gets confiscated next time (instead of being imprisoned
				; again).
				;
				; To fix this hack we need to have an OnGlobalPlayerDocked event in which
				; we check for a smuggled sealed container (and set the appropriate crime)
				; instead of the setting the crime inside of GetGlobalDockScreen (which
				; should not have any side-effects).
				
				(if
					(and (not (objGetItems gPlayerShip "*I+SmugglersHold;")) 
							(objGetItems gPlayerShip "*U+SealedContainer;"))
						(objSetData gPlayerShip "00001002_ConfiscateSealedContainer" True)
						
					(objSetData gPlayerShip "00001002_ConfiscateSealedContainer" Nil)
					)
					
				; Same thing for slaves
				
				(if
					(and (objGetData gPlayerShip "slaveSales")
							(objGetItems gPlayerShip "* +Slaves;"))
						(objSetData gPlayerShip "00001002_ConfiscateSlaves" True)
						
					(objSetData gPlayerShip "00001002_ConfiscateSlaves" Nil)
					)
				))
				
			(setq comTrafficControl (lambda (homeObj maxTraffic)
				(if (ls (count (sysFindObject homeObj "s D:0010300C_traffic;")) maxTraffic)
					(block (theShip)
						(setq theShip (sysCreateShip
							&tbCommTraffic;
							(random (sysFindObject Nil "G -uncharted;"))
							&svCommonwealth;
							&evCommTrafficBehavior;
							))
						(objSetObjRefData theShip "home" homeObj)
						(objFireEvent theShip "OrderBeginTraffic")
						)
					)
				))

			(setq intCommonwealthCrime (lambda (severity description)
				(if (gr severity (int (objGetData gPlayerShip "commonCrimeSeverity")))
					(block Nil
						(objSetData gPlayerShip "commonCrimeSeverity" severity)
						(objSetData gPlayerShip "commonCrime" description)
						)
					)
				))

			(setq intCommonwealthOnDestroy (lambda Nil
				(block Nil
					; Destroy items on the station
					(rpgDestroyItems gSource)

					; Add to the player's record
					(if (and gPlayerShip (eq aOrderGiver gPlayerShip))
						(intCommonwealthCrime 3 (cat "the destruction of " (objGetName gSource 4)))
						)
					)
				))
			)
	</Globals>

	<!-- Commonwealth Confiscate -->

	<DockScreen UNID="&dsCommonwealthConfiscate;"	nestedScreen="true">

		<Panes>
			<Default>
				<OnPaneInit>
					(block (desc itemToRemove itemsToConfiscate)
					
						; If we don't have a smuggler's cargo hold, then we confiscate
						; all illegal items.
						(if (not (objGetItems gPlayerShip "*I+SmugglersHold"))
							(setq itemsToConfiscate 
								(objGetItems gPlayerShip "*U +Illegal; -ID;")
								)
							)
							
						; If we don't have a military ID, then confiscate military items
						; NOTE: In this case, we honor any military ID.
						(if (not (objGetItems gPlayerShip "*+MilitaryID"))
							(setq itemsToConfiscate (append itemsToConfiscate
								(objGetItems gPlayerShip "*U +Military; -ID;")
								))
							)
					
						; Remove items
						(enum itemsToConfiscate itemToRemove
							(objRemoveItem gPlayerShip itemToRemove)
							)

						; Compose text
						(setq desc "Commonwealth Customs has inspected your ship's cargo hold and confiscated ")
						(if (eq (count itemsToConfiscate) 1)
							(scrSetDesc gScreen (cat desc (itmGetName (item itemsToConfiscate 0) 8) "."))
							(block (i)
								(for i 0 (subtract (count itemsToConfiscate) 3)
									(setq desc (cat desc (itmGetName (item ItemsToConfiscate i) 8) ", "))
									)
								(setq desc (cat desc (itmGetName (item ItemsToConfiscate (subtract (count itemsToConfiscate) 2)) 8) " and "))
								(setq desc (cat desc (itmGetName (item ItemsToConfiscate (subtract (count itemsToConfiscate) 1)) 8) "."))
								(scrSetDesc gScreen desc)
								)
							)
						)
				</OnPaneInit>

				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(block Nil
							(comSealedContainerHack)
							(scrExitScreen gScreen)
							)
					</Action>
				</Actions>
			</Default>
		</Panes>
	</DockScreen>

	<!-- Commonwealth Decontamination -->

	<DockScreen UNID="&dsCommonwealthDecon;"	nestedScreen="true">
		<Panes>
			<Default>
				<OnPaneInit>
					(block (
						(currencyUsed (objGetProperty gSource 'currency))
						(cost (ecoExchange 250 'credit currencyUsed))
						)
						(if (geq (objGetBalance gPlayerShip currencyUsed) cost)
							(block Nil
								(scrSetDescTranslate gScreen 'customs.chargedForDecon { cost:(fmtCurrency currencyUsed cost) })
								(objCharge gPlayerShip currencyUsed cost)
								(shpDecontaminate gPlayerShip)
								)
							(scrSetDescTranslate gScreen 'customs.cantAffordDecon { cost:(fmtCurrency currencyUsed cost) })
							)
						)
				</OnPaneInit>

				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						; If the ship is still radioactive, force undock.
						; Otherwise, we just exit the screen and go back to the default screen
						
						(scrExitScreen gScreen (shpIsRadioactive gPlayerShip))
					</Action>
				</Actions>
			</Default>
		</Panes>
		
		<Language>
			<Text id="customs.chargedForDecon">
				(cat
					"Commonwealth Customs stops your ship for decontamination. "
					"You are automatically charged " (@ gData 'cost) " for decontaminating your ship."
					)
			</Text>
			<Text id="customs.cantAffordDecon">
				(cat
					"Commonwealth Customs stops your ship for decontamination. "
					"Unfortunately, you do not have " (@ gData 'cost) " to pay for decontamination."
					)
			</Text>
		</Language>
	</DockScreen>

	<!-- Commonwealth Free Slaves -->

	<DockScreen UNID="&dsCommonwealthFreeSlaves;"	nestedScreen="true">

		<Panes>
			<Default>
				<OnPaneInit>
					(block (desc itemToRemove)
						; Free the slaves
						(setq totalSlaves 0)
						(enum (objGetItems gPlayerShip "*+Slaves;") itemToRemove
							(block Nil
								(setq totalSlaves (add totalSlaves (itmGetCount itemToRemove)))
								(objRemoveItem gPlayerShip itemToRemove)
								)
							)

						; Keep track of how many we have freed in total
						(objIncData gPlayerShip "slavesFreed" totalSlaves)

						; Create description
						(setq desc "As soon as you dock you inform the Commonwealth authorities that you have rescued ")
						(switch
							(eq totalSlaves 1)
								(setq desc (cat desc "a slave. The jaded officer takes the slave coffin and files a routine report."))

							(eq totalSlaves 2)
								(setq desc (cat desc "a couple of slaves. The jaded officer takes the two slave coffins and files a routine report."))

							(setq desc (cat desc "several slaves. The officer in charge thanks you for your role in the rescue: \"You must have a pretty good ship to have survived a fight against Slavers!\""))
							)

						(scrSetDesc gScreen desc)
						)
				</OnPaneInit>

				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(block (freed rewarded)
							(setq freed (objGetData gPlayerShip "slavesFreed"))
							(setq rewarded (objGetData gPlayerShip "slaveReward"))

							(switch
								(and (geq freed 12) (ls rewarded 12))
									(scrShowPane gScreen "Reward1")

								(and (geq freed 24) (ls rewarded 24))
									(scrShowPane gScreen "Reward1")

								(scrExitScreen gScreen)
								)
							)
					</Action>
				</Actions>

			</Default>

			<Reward1>
				<OnPaneInit>
					(block (reward roll)
						; Create a random reward
						(setq roll (random 1 100))
						(switch
							(ls roll 25)
								(setq reward (itmCreate &itLongzhuSphere; (random 1 3)))

							(ls roll 60)
								(setq reward (itmCreate &itPromethiumCrystal; (random 1 4)))

							(setq reward (itmCreate &itCalligraphyScroll; 1))
							)

						; Give it to the player
						(objAddItem gPlayerShip reward)
						(scrSetDesc gScreen (cat "Once revived, one of the former slaves turns to you and puts something in your hand. She turns and walks away without saying a word. When you open your hand you see: " (itmGetName reward 8) "."))
						)
				</OnPaneInit>

				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(block Nil
							(objSetData gPlayerShip "slaveReward" (objGetData gPlayerShip "slavesFreed"))
							(scrExitScreen gScreen)
							)
					</Action>
				</Actions>
			</Reward1>
		</Panes>

	</DockScreen>

	<!-- Commonwealth Imprison -->

	<DockScreen UNID="&dsCommonwealthImprison;"	nestedScreen="true">
		<Panes>
			<Default>
				<OnPaneInit>
					(scrSetDesc gScreen 
						"As you enter the station you are surrounded by heavily armed soldiers. "
						"A Commonwealth official approaches you:\n\n"
						"\"You are under arrest for " (objGetData gPlayerShip "commonCrime") ".\"" 
						)
				</OnPaneInit>

				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(scrShowPane gScreen "TrialIntro")
					</Action>
				</Actions>
			</Default>
			
			<TrialIntro>
				<OnPaneInit>
					(scrSetDesc gScreen
						"You appear before a magistrate who reads out the charges:\n\n"
						"\"%name%, you are accused of " (objGetData gPlayerShip "commonCrime") ". "
						"How do you plead?\""
						)
				</OnPaneInit>
				
				<Actions>
					<Action name="&quot;Guilty.&quot;" default="1" cancel="1" key="G">
						(switch
							; If this is a serious crime, then always prison
							(eq (objGetData gPlayerShip "commonCrimeSeverity") 3)
								(block Nil
									(setq gResult (cat
										"\"In view of the seriousness of the crime, the Court has no choice "
										"but to sentence you to a minimum of ten years in a Commonwealth rehabilitation colony.\n\n"
										"\"Court dismissed!\""
										))
									(scrShowPane gScreen "VerdictImprison")
									)

							; If first offense, then the court is lenient
							(not (objGetData gPlayerShip "commonCrimeRecord"))
								(block Nil
									(setq gCost 5000)
									(setq gResult (cat
										"\"In view of your otherwise clean record, and your acceptance of responsibility, "
										"the Commonwealth fines you the sum of " gCost " credits for your crimes.\n\n"
										"\"Court dismissed!\""
										))
									(scrShowPane gScreen "VerdictRelease")
									)
									
							; If second offense, then we're still lenient
							(eq (objGetData gPlayerShip "commonCrimeRecord") 1)
								(block Nil
									(setq gCost 25000)
									(setq gResult (cat
										"\"In view of your acceptance of responsibility, "
										"the Commonwealth fines you the sum of " gCost " credits for your crimes.\n\n"
										"\"Court dismissed!\""
										))
									(scrShowPane gScreen "VerdictRelease")
									)
									
							; Otherwise, locked away
							(block Nil
								(setq gResult (cat
									"\"Your past criminal record gives me no expectation of future good behavior. "
									"You are hereby sentenced to twenty years in a Commonwealth rehabilitation colony.\n\n"
									"\"Court dismissed!\""
									))
								(scrShowPane gScreen "VerdictImprison")
								)
							)
					</Action>
					
					<Action name="&quot;Not guilty!&quot;" key="N">
						(switch
							; Sometimes there is not enough evidence
							(leq (random 1 100) 25)
								(block Nil
									(setq gResult (cat
										"After a lengthy trial, the Court finds you not guilty due to lack of evidence.\n\n"
										"\"Our laws compel us to set you free. But if you are guilty, you may find "
										"your conscience to be more of a torment than prison ever could.\n\n"
										"\"Court dismissed!\""
										))
									(scrShowPane gScreen "VerdictNotGuilty")
									)
									
							; If this is a serious crime, then always prison
							(eq (objGetData gPlayerShip "commonCrimeSeverity") 3)
								(block Nil
									(setq gResult (cat
										"After a trial, the Court finds you guilty as charged.\n\n"
										"\"In view of the seriousness of the crime, the Court sentences you to "
										"life without parole in a Commonwealth rehabilitation colony.\n\n"
										"\"Court dismissed!\""
										))
									(scrShowPane gScreen "VerdictImprison")
									)

							; If first offense, then the court is lenient
							(not (objGetData gPlayerShip "commonCrimeRecord"))
								(block Nil
									(setq gCost 25000)
									(setq gResult (cat
										"After a short trial, the Court finds you guilty as charged.\n\n"
										"\"In view of your otherwise clean record "
										"the Commonwealth fines you the sum of " gCost " credits for your crimes.\n\n"
										"\"Court dismissed!\""
										))
									(scrShowPane gScreen "VerdictRelease")
									)
									
							; Otherwise, locked away
							(block Nil
								(setq gResult (cat
									"After a trial, the Court finds you guilty as charged.\n\n"
									"\"Your past criminal record gives me no expectation of future good behavior. "
									"You are hereby sentenced to twenty years in a Commonwealth rehabilitation colony.\n\n"
									"\"Court dismissed!\""
									))
								(scrShowPane gScreen "VerdictImprison")
								)
							)
					</Action>
				</Actions>
			</TrialIntro>
			
			<VerdictNotGuilty>
				<OnPaneInit>
					(scrSetDesc gScreen gResult)
				</OnPaneInit>
				
				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(block Nil
							(objSetData gPlayerShip "commonCrimeSeverity" 0)
							(objSetData gPlayerShip "commonCrime" Nil)
							(comSealedContainerHack)
							(scrExitScreen gScreen)
							)
					</Action>
				</Actions>
			</VerdictNotGuilty>
			
			<VerdictRelease>
				<OnPaneInit>
					(scrSetDesc gScreen gResult)
				</OnPaneInit>
				
				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(if (geq (plyGetCredits gPlayer) gCost)
							(block Nil
								(plyCharge gPlayer gCost)
								(objIncData gPlayerShip "commonCrimeRecord" 1)
								(objSetData gPlayerShip "commonCrimeSeverity" 0)
								(objSetData gPlayerShip "commonCrime" Nil)
								(comSealedContainerHack)
								(scrExitScreen gScreen)
								)
							(scrShowPane gScreen "CantPay")
							)
					</Action>
				</Actions>
			</VerdictRelease>
			
			<VerdictImprison>
				<OnPaneInit>
					(scrSetDesc gScreen gResult)
				</OnPaneInit>
				
				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(block Nil
							(plyDestroyed gPlayer (cat "was imprisoned for " (objGetData gPlayerShip "commonCrime")))
							(scrExitScreen gScreen 'forceUndock)
							)
					</Action>
				</Actions>
			</VerdictImprison>

			<CantPay>
				<OnPaneInit>
					(scrSetDesc gScreen
						"Unfortunately, you cannot afford to pay the fine. "
						"The Commonwealth decides to sell your ship to cover your debt."
						)
				</OnPaneInit>
				
				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(block Nil
							(plyDestroyed gPlayer (plyComposeString gPlayer (cat "lost %his% ship after a criminal conviction")))
							(scrExitScreen gScreen 'forceUndock)
							)
					</Action>
				</Actions>
			</CantPay>
		</Panes>
	</DockScreen>

	<!-- Donate Item to Container Habitat

		gPrevScreen: Must be set to the name/UNID of the screen to
				navigate to when done.
		gPrevPane: Must be set to the name of the pane to navigate
				to when done.
		-->

	<DockScreen UNID="&dsContainerHabitatDonateItem;"
			type=				"itemPicker"
			>

		<ListOptions
			dataFrom=	"player"
			list=		"*U"
			/>

		<Panes>
			<Default>
				<OnPaneInit>
					(block Nil
						(setq gItem (scrGetItem gScreen))
						(setq gMaxCount (itmGetCount gItem))
						(scrSetDesc gScreen "\"What do you want to give us?\"")
						)
				</OnPaneInit>

				<Actions>
					<Action name="Donate this Item" default="1" key="D">
						(switch
							(gr gMaxCount 1)
								(scrShowPane gScreen "Quantity")

							(eq gMaxCount 1)
								(block Nil
									(setq gItem (scrRemoveItem gScreen 1))
									(scrShowScreen gScreen "&dsContainerHabitatReward;" "Donate")
									)
							)
					</Action>

					<Action name="Cancel" cancel="1" key="C">
						(scrShowScreen gScreen gPrevScreen gPrevPane)
					</Action>
				</Actions>					
			</Default>

			<Quantity
					showCounter=	"true">

				<OnPaneInit>
					(block Nil
						(scrSetDesc gScreen (cat "\"How many " (itmGetName gItem 0x02) " do you want to give us?\""))
						(scrSetCounter gScreen gMaxCount)
						)
				</OnPaneInit>

				<Actions>
					<Action name="Donate" default="1" key="D">
						(block (count)
							(setq count (scrGetCounter gScreen))
							(if (gr count gMaxCount)
								(scrSetCounter gScreen gMaxCount)
								(block Nil
									(setq gItem (scrRemoveItem gScreen count))
									(scrShowScreen gScreen "&dsContainerHabitatReward;" "Donate")
									)
								)
							)
					</Action>

					<Action name="Cancel" cancel="1" key="C">
						<ShowPane pane="Default"/>
					</Action>

				</Actions>
			</Quantity>

		</Panes>

	</DockScreen>

	<DockScreen UNID="&dsContainerHabitatReward;">
		<Panes>
			<Donate>
				<OnPaneInit>
					(block (table entry criteria totalValue)
						; Look for the entry in the donation table

						(setq table (objGetStaticData gSource "DonationTable"))
						(setq entry Nil)
						(enumwhile table (not entry) thisEntry
							(switch
								; If the criteria in the table is Nil, then we always match. This
								; is for the last (default) entry.
								(not (setq criteria (item thisEntry 0)))
									(setq entry thisEntry)

								; If the criteria is an integer, then we see if this is the UNID
								; of the item.
								(isint criteria)
									(if (eq (itmGetType gItem) criteria)
										(setq entry thisEntry)
										)

								; If the criteria matches, then we have an entry
								(itmMatches gItem criteria)
									(setq entry thisEntry)
								)
							)

						; Deal with the entry that we found

						(setq gResult (item entry 2))

						; Calculate how valuable the donation was
						
						(switch
							; If the player donated rotted food, then we're insulted
							(and (itmMatches gItem "* +FreshFood;") (eq (objGetBuyPrice gSource gItem) 0))
								(block Nil
									(setq gResult 'rottedFood)
									(setq gResultValue Nil)
									)
							
							; If 0, then we get result regardless of quantity
							(eq (item entry 1) 0)
								(setq gResultValue Nil)

							; If -1, then each item counts for +1 donation points
							(eq (item entry 1) -1)
								(setq gResultValue (itmGetCount gItem))

							; Otherwise, depends on the value of the item
							(block Nil
								(setq totalValue (multiply (objGetBuyPrice gSource gItem) (itmGetCount gItem)))
								(setq gResultValue (divide totalValue (item entry 1)))
								)
							)
							
						; Accumulate donation points
						
						(block (donationPoints)
							(setq donationPoints (objGetGlobalData gSource "donationPoints"))
							(if (not donationPoints) (setq donationPoints 0))

							(if gResultValue
								(setq donationPoints (add donationPoints gResultValue))
								)

							(objSetGlobalData gSource "donationPoints" donationPoints)
							)

						; Deal with the result appropriately

						(switch
							(and gResultValue (eq gResultValue 0))
								(block Nil
									(setq desc "\"Thanks, that's something we need more of around here.\"")
									(setq gResult 'thanksForNothing)
									)

							(eq gResult 'info)
								(setq desc (cat
									"\"Thank you, %sir%! We'll put " (itmGetName gItem 0x40) " to good use. Maybe I can help you in return.\""
									))
									
							(eq gResult 'rottedFood)
								(block Nil
									(setq desc (cat
										"\"Kack! What do you think we're going to do with that? Thanks for nothing!\""
										))
									(objSetGlobalData gSource "donationPoints" 0)
									)

							; Thanks for nothing
							(block Nil
								(setq desc (cat
									"\"Yeah, I guess you won't be needing" 
									(if (gr (itmGetCount gItem) 1) " them " " that ")
									"where you're going. Not sure we need"
									(if (gr (itmGetCount gItem) 1) " them " " it ")
									"ourselves, but thanks anyway.\""
									))
								(setq gResult 'thanksForNothing)
								)
							)

						(scrSetDesc gScreen desc)
						)
				</OnPaneInit>

				<Actions>
					<Action name="Continue" cancel="1" default="1" key="C">
						(switch
							(eq gResult 'info)
								(if (geq (objGetGlobalData gSource "donationPoints") 5)
									(scrShowPane gScreen "RewardInfo")
									(scrShowPane gScreen "RewardInfoRumors")
									)

							(scrShowScreen gScreen gPrevScreen gPrevPane)
							)
					</Action>
				</Actions>

			</Donate>

			<RewardInfo>
				<OnPaneInit>
					(block (donationPoints)
						(scrSetDesc gScreen (cat
							"\"I know a thing or two about getting around in this system. What do you need to know?\""
							))

						(setq donationPoints (objGetGlobalData gSource "donationPoints"))

						; Equipment location available after 5 donation points
						(scrShowAction gScreen 0 (geq donationPoints 5))

						; Centauri warlords info available in Eridani after 10 points
						(scrShowAction gScreen 1 
							(and (geq donationPoints 10) (eq (sysGetNode) 'SE))
							)

						; Arco Vaughn info available after 20 points and only in SE or if he
						; is still alive
						(scrShowAction gScreen 2 
							(and (geq donationPoints 20)
								(eq (sysGetNode) 'SE)
								(not (eq (typGetGlobalData &scArcoVaughnHeavyRaider; "status") 'destroyed))
								)
							)

						; Korolov station info available after 5 points if past SE
						(scrShowAction gScreen 3
							(and (geq donationPoints 5)
								(not (eq (sysGetNode) 'SE))
								(leq (sysGetLevel) 3)
								)
							)
						)
				</OnPaneInit>

				<Actions>
					<Action name="&quot;I need better equipment.&quot;" key="e">
						(scrShowPane gScreen "RewardInfoEquipment")
					</Action>

					<Action name="&quot;Where are the Centauri warlords?&quot;" key="C">
						(scrShowPane gScreen "RewardInfoCentauriBase")
					</Action>

					<Action name="&quot;Where is Arco Vaughn?&quot;" key="A">
						(scrShowPane gScreen "RewardInfoArcoVaughn")
					</Action>

					<Action name="&quot;Is there a Korolov station nearby?&quot;" key="K">
						(scrShowPane gScreen "RewardInfoKorolov")
					</Action>

					<Action name="&quot;Nevermind, I'm all set.&quot;" key="N" cancel="1">
						(scrShowScreen gScreen gPrevScreen gPrevPane)
					</Action>
				</Actions>
			</RewardInfo>

			<RewardInfoRumors>
				<OnPaneInit>
					(scrSetDesc gScreen (cat
						"The station master grabs you and speaks softly in your ear:\n\n"
						(switch
							(and (eq (sysGetNode) 'SE)
									(not (eq (typGetGlobalData &scArcoVaughnHeavyRaider; "status") 'destroyed)))
								(random (objGetStaticData gSource "RumorsSE"))

							(eq (sysGetNode) 'BA)
								(random (objGetStaticData gSource "RumorsBA"))

							(random (objGetStaticData gSource "Rumors"))
							)
						))
				</OnPaneInit>

				<Actions>
					<Action name="Continue" cancel="1" default="1" key="C">
						(scrShowScreen gScreen gPrevScreen gPrevPane)
					</Action>
				</Actions>
			</RewardInfoRumors>

			<RewardInfoEquipment>
				<OnPaneInit>
					(block (desc bestObj bestItem allItems bestItems)
						(setq aTargetObj Nil)
						(setq aEvent Nil)
						(setq desc "")

						; Make a list of all potential items
						(setq allItems Nil)
						(enum (sysFindObject gSource "T") theObj
							(enum (objGetItems theObj "wsUN") theItem
								(if	(and (geq (itmGetLevel theItem) 3)
										(not (objHasItem gPlayerShip theItem))
										(or (objIsEnemy gPlayerShip theObj)
											(gr (objGetSellPrice theObj theItem) 0)))
									(setq allItems (append allItems (list (list theObj theItem))))
									)
								)
							)

						; Filter out any items that the player already has installed
						(setq allItems (filter allItems theEntry
							(not 
								; This filter returns the set of installed items that is equal
								; to the items that we found
								(filter (objGetItems gPlayerShip "wsI") theItem
									(eq (itmGetType theItem) (itmGetType (item theEntry 1)))
									)
								)
							))

						; Make a list of lootable items or items that the player doesn't know about
						(setq bestItems (filter allItems theEntry
							(or (objIsEnemy gPlayerShip (item theEntry 0))
								(not (objIsKnown (item theEntry 0)))
								)
							))
						(if (not bestItems)
							(setq bestItems allItems)
							)

						; Pick a random high-level item
						(setq bestItem Nil)
						(setq bestObj Nil)
						(if bestItems
							(for i 1 10
								(block (trialEntry)
									(setq trialEntry (random bestItems))
									(if (or (not bestItem)
											(gr (itmGetLevel (item trialEntry 1)) (itmGetLevel bestItem)))
										(block Nil
											(setq bestObj (item trialEntry 0))
											(setq bestItem (item trialEntry 1))
											)
										)
									)
								)
							)

						; If an item was found, then set up everything
						(if bestItem
							(block Nil
								(setq desc (cat desc
									"\""
									(objGetName bestObj 0x05) " in this system has "
									(itmGetName bestItem 0x04) ". "
									(if (objIsEnemy gPlayerShip bestObj)
										"If you destroy the station, you will be able to loot it. "
										"If you go to the station you will be able to buy it. "
										)
									"I'll give you the coordinates, if you want.\""
									))

								(setq aTargetObj bestObj)
								(if (objIsEnemy gPlayerShip bestObj)
									(setq aEvent "OrderDestroyTarget")
									(setq aEvent "OrderDockWithTarget")
									)
								)

							; Otherwise, if no item found, then we're sorry
							(setq desc (cat desc
								"\"Sorry, I don't know of anything in the system that could help you.\""
								))
							)

						(scrSetDesc gScreen desc)

						; Enable disable buttons
						(scrShowAction gScreen 0 aEvent)
						(scrShowAction gScreen 1 aEvent)
						(scrShowAction gScreen 2 (not aEvent))
						)
				</OnPaneInit>

				<Actions>
					<Action name="&quot;Give me the coordinates, please!&quot;" key="C" default="1">
						(block Nil
							(objFireEvent gSource aEvent)
							(scrShowPane gScreen "RewardInfoDone")
							)
					</Action>

					<Action name="&quot;Nevermind, I'm all set.&quot;" key="N" cancel="1">
						(scrShowScreen gScreen gPrevScreen gPrevPane)
					</Action>

					<Action name="Continue" cancel="1" default="1" key="C">
						(scrShowScreen gScreen gPrevScreen gPrevPane)
					</Action>
				</Actions>
			</RewardInfoEquipment>

			<RewardInfoCentauriBase>
				<OnPaneInit>
					(block (desc targetList)
						(setq aTargetObj Nil)
						(setq aEvent Nil)
						(setq desc "The station master grabs you and speaks softly in your ear:\n\n")

						(setq targetList (sysFindObject gSource "TA +centauriWarlords; +populated; -occupation; -uncharted;"))
						(if targetList
							(block Nil
								(setq aTargetObj (random targetList))
								(setq desc (cat desc
									"\"I know the location of one of the Centauri bases. I'll give you the coordinates so that you can destroy it. But don't tell anyone where you got it, OK?\""
									))

								; Set player target
								(setq aEvent "OrderDestroyTarget")
								)
							(setq desc "\"Sorry, I don't know of any active Centauri bases in this system.\"")
							)

						(scrSetDesc gScreen desc)

						; Enable disable buttons
						(scrShowAction gScreen 0 aEvent)
						(scrShowAction gScreen 1 aEvent)
						(scrShowAction gScreen 2 (not aEvent))
						)

				</OnPaneInit>

				<Actions>
					<Action name="&quot;Give me the coordinates, please!&quot;" key="C" default="1">
						(block Nil
							(objFireEvent gSource aEvent)
							(scrShowPane gScreen "RewardInfoDone")
							)
					</Action>

					<Action name="&quot;Nevermind, I'm all set.&quot;" key="N" cancel="1">
						(scrShowScreen gScreen gPrevScreen gPrevPane)
					</Action>

					<Action name="Continue" cancel="1" default="1" key="C">
						(scrShowScreen gScreen gPrevScreen gPrevPane)
					</Action>
				</Actions>
			</RewardInfoCentauriBase>

			<RewardInfoArcoVaughn>
				<OnPaneInit>
					(block (desc targetList)
						(setq aTargetObj Nil)
						(setq aEvent Nil)
						(setq desc "The station master grabs you and speaks softly in your ear:\n\n")

						(switch
							(eq (typGetGlobalData &scArcoVaughnHeavyRaider; "status") 'destroyed)
								(setq desc (cat
									"\"Arco Vaughn is dead, thankfully!\""
									))

							(not (sysFindObject gSource "s +arcoVaughn;"))
								(setq desc (cat
									"\"Arco Vaughn is not in this system; last I heard he was in the Eridani system.\""
									))

							(block Nil
								(setq desc (cat desc
									"\"If you're hunting Arco Vaughn, I know where you can find him. He has a habitat deep in the outer system. "
									"I'll give you his coordinates, but don't say where you got them.\""
									))

								; Set player target
								(setq aTargetObj (sysFindObject gSource "sN +arcoVaughn;"))
								(setq aEvent "OrderDestroyTarget")
								)
							)

						(scrSetDesc gScreen desc)

						; Enable disable buttons
						(scrShowAction gScreen 0 aEvent)
						(scrShowAction gScreen 1 aEvent)
						(scrShowAction gScreen 2 (not aEvent))
						)
				</OnPaneInit>

				<Actions>
					<Action name="&quot;Give me his coordinates, please!&quot;" key="C" default="1">
						(block Nil
							(objFireEvent gSource aEvent)
							(scrShowPane gScreen "RewardInfoDone")
							)
					</Action>

					<Action name="&quot;Nevermind, I'm all set.&quot;" key="N" cancel="1">
						(scrShowScreen gScreen gPrevScreen gPrevPane)
					</Action>

					<Action name="Continue" cancel="1" default="1" key="C">
						(scrShowScreen gScreen gPrevScreen gPrevPane)
					</Action>
				</Actions>
			</RewardInfoArcoVaughn>

			<RewardInfoKorolov>
				<OnPaneInit>
					(block (desc targetList)
						(setq aTargetObj Nil)
						(setq aEvent Nil)

						(setq targetList (sysFindObject gSource "TA +korolovShipping; +populated; -occupation; -uncharted;"))
						(if targetList
							(block Nil
								(setq aTargetObj (random targetList))
								(setq desc (cat 
									"The station master is happy to oblige:\n\n"
									"\"Yeah, there's a Korolov station in this system. I can give you their coordinates, if you want.\""
									))

								; Set player target
								(setq aEvent "OrderDockWithTarget")
								)
							(setq desc (cat 
								"The station master thinks for a moment:\n\n"
								"\"No, sorry, there aren't any in this system, as far as I know.\""
								))
							)

						(scrSetDesc gScreen desc)

						; Enable disable buttons
						(scrShowAction gScreen 0 aEvent)
						(scrShowAction gScreen 1 aEvent)
						(scrShowAction gScreen 2 (not aEvent))
						)
				</OnPaneInit>

				<Actions>
					<Action name="&quot;Give me their coordinates, please!&quot;" key="C" default="1">
						(block Nil
							(objFireEvent gSource aEvent)
							(scrShowPane gScreen "RewardInfoDone")
							)
					</Action>

					<Action name="&quot;Nevermind, I'm all set.&quot;" key="N" cancel="1">
						(scrShowScreen gScreen gPrevScreen gPrevPane)
					</Action>

					<Action name="Continue" cancel="1" default="1" key="C">
						(scrShowScreen gScreen gPrevScreen gPrevPane)
					</Action>
				</Actions>
			</RewardInfoKorolov>

			<RewardInfoDone>
				<OnPaneInit>
					(scrSetDesc gScreen (cat
						"\"Done. Just follow the marker on your display and you will get there."
						(if (objIsEnemy gSource aTargetObj)
							" Remember, don't say anything about where you got it.\""
							"\""
							)
						))
				</OnPaneInit>

				<Actions>
					<Action name="Continue" key="C" default="1" cancel="1">
						<Exit/>
					</Action>
				</Actions>
			</RewardInfoDone>
		</Panes>
	</DockScreen>

	<!-- Dry dock screen -->

	<DockScreen UNID="&dsDryDock;"
			inherit=			"&dsDockScreenBase;"
			>
		
		<Panes>
			<Default>
				<OnPaneInit>
					(scrSetDescTranslate gScreen 'descWelcome)
				</OnPaneInit>

				<Actions>
					<Action id="actionDockServices" default="1">
						(rpgDockServices gPlayerShip {
							checkMilitaryID: True
							})
					</Action>
					
					<Action id="actionUndock" cancel="1">
						<Exit/>
					</Action>
				</Actions>
			</Default>
		</Panes>
		
		<Language>
			<Text id="descWelcome">"Your ship is in dry dock."</Text>
		</Language>
	</DockScreen>
	
<!-- BASIC COMMONWEALTH RULES

	PLAYER DATA
	
	commonCrime:	Description of the player's crime (e.g., "slave-trading")
	commonCrimeSeverity: The severity of the crime
						0 = No crime
						1 = Misdemeanor (drug possession)
						2 = Felony (piracy)
						3 = Crimes against Humanity (slave-trading, genocide, mass-destruction)
	commonCrimeRecord: Number of times player has been caught and released for a felony
	
-->

	<Sovereign UNID="&svCommonwealth;"
			name=":the Commonwealth"
			adjective="Commonwealth"
			demonym=":a Commonwealth citizen(s)"

			alignment="constructive chaos"
			>

		<Events>
			<GetGlobalDockScreen>
				; If the player has docked with an active commonwealth station
				; with customs, then we need to check for various things
				; (like radiation poisoning and smuggling).
				;
				; NOTE: We return a screen and a priority. The priority is used
				; to decide whether other screens should be shown before or after
				; these. Follow these rules:
				;
				; Screens that prevent docking:				10
				; Screens that imprison the player:			8
				; Screens that confiscate:					6
				; Screens that complete missions:			4
				
				(switch
					; This does not apply to stations without customs
					(not (objMatches gSource Nil "sTAV +commonwealthCustoms;"))
						Nil

					; If customs is temporarily disabled, then we don't do anything.
					(= (objFireEvent gSource 'GetCommonwealthCustomsStatus) 'disabled)
						Nil

					; If the player ship is radioactive, then we need to
					; decontaminate.
					(shpIsRadioactive gPlayerShip)
						(list &dsCommonwealthDecon; 10)

					; If the player has sold slaves then he/she is arrested.
					(geq (int (objGetData gPlayerShip "commonCrimeSeverity")) 2)
						(list &dsCommonwealthImprison; 8)
						
					; If the player has slaves then free them
					(and (objGetItems gPlayerShip "*+Slaves;")
							(not (objGetData gPlayerShip "00001002_ConfiscateSlaves"))
							)
						(list &dsCommonwealthFreeSlaves; 8)
						
					; If the player has a black market container, then she is imprisoned
					(and (not (objGetItems gPlayerShip "*I+SmugglersHold;")) 
							(objGetItems gPlayerShip "*U+SealedContainer;")
							(not (objGetData gPlayerShip "00001002_ConfiscateSealedContainer"))
							)
						(block Nil
							; This side-effect is OK because it is OK if we call it multiple
							; times, and it is OK if some other screen takes priority.
							(intCommonwealthCrime 2 "smuggling")
							
							(list &dsCommonwealthImprison; 8)
							)
							
					; If we have illegal items in the cargo hold then we need
					; to confiscate them
					(and (not (objGetItems gPlayerShip "*I+SmugglersHold"))
							(or (objGetItems gPlayerShip "*U+Illegal; -ID")
								(and (objGetItems gPlayerShip "*U+Military") (not (objGetItems gPlayerShip "*+MilitaryID")))))
						(list &dsCommonwealthConfiscate; 6)

					Nil
					)
			</GetGlobalDockScreen>
			
			<OnGlobalPlayerSoldItem>
				(switch
					;	If the player sold slaves, chance they get caught
					
					(itmHasAttribute gItem 'slaves)
						(block ()
							(objIncData gPlayerShip 'slaveSales (ecoExchange aPrice aCurrency 'credit))

							(if (ls (random 1 50) (itmGetCount gItem))
								(intCommonwealthCrime 2 "slave-trading")
								)
							)
					)
			</OnGlobalPlayerSoldItem>
		</Events>
	</Sovereign>

	<EconomyType UNID="&ecCreditEconomy;"
			id=				"credit" 
			currency=		"credit(s)"
			conversion=		"100"
			/>

<!-- BEHAVIORS -->

	<!-- Commonwealth Traffic Behavior
	
		USAGE NOTES
		
		This controls random ships that travel between Commonwealth stations.
		To use:
		
		1. Create the ship at a stargate
		2. Set the event handler
		3. Set the home station
		4. Call "OrderBeginTraffic"
	
		EXTRA DATA
		
		behavior:			Ship's current behavior
								'enteredSystem			= Ship just entered the system
								'docked					= Ship is docked somewhere
								'leavingSystem			= Ship is heading out of the system
								
		home:				Ship's home station

	-->

	<ShipClass UNID="&evCommTrafficBehavior;"
			class=				"(commonwealth traffic behavior)"
			virtual=			"true"
			
			attributes=			"behaviorClass"
			>

		<Events>
			<OrderBeginTraffic>
				(block (homeObj)
					; If the home station is not set, set it now
					(if (not (setq homeObj (objGetObjRefData gSource "home")))
						(block Nil
							(setq homeObj (sysFindObject gSource "TAFN +commonwealth; +primary;"))
							(if (not homeObj)
								(setq homeObj (sysFindObject gSource "TAFN +populated; -occupation;"))
								)

							(objSetObjRefData gSource "home" homeObj)
							)
						)

					; Set data so we know we are traffic
					(objSetData gSource "0010300C_traffic" True)

					; Set state
					(objSetData gSource "behavior" 'enteredSystem)
					)
			</OrderBeginTraffic>
			
			<OnOrdersCompleted>
				(block (behavior newBehavior allDests dockedAt allWrecks allLoot)
					(setq behavior (objGetData gSource "behavior"))
					(setq dockedAt (shpGetDockObj gSource))
					
					; If we're docked at an object, dump any loot that we found
					(if (and dockedAt
							(objHasAttribute dockedAt "populated")
							
							; Compose a list of all loot on board that the station
							; might want to buy from us.
							
							(setq allLoot (filter (objGetItems gSource "*~mf U") theItem
								(objGetBuyPrice dockedAt theItem)
								))
							)
						(block Nil
							(enum allLoot theItem (objRemoveItem gSource theItem))
							(enum allLoot theItem (objAddItem dockedAt theItem))
							)
						)
					
					; Figure out what to do next
					(switch

						; Check for wrecks in the area; if we find some, then loot them
						(and (leq (objGetDestiny gSource) 180)
								(not (objHasAttribute gSource "freighter"))
								(leq (random 1 100) 50)
								
								; Compose a list of all wrecks in the area
								
								(setq allWrecks (filter (sysFindObject gSource "TK N:100; +shipwreck; -uncharted; -locked;") theObj
									(and 
										(not (objIsRadioactive theObj))
										(not (objGetData theObj "0010300c_marked"))
										)
									))
								)
							(block (destObj)
								(setq destObj (random allWrecks))
								(shpOrder gSource 'loot destObj)
								(objSetData destObj "0010300c_marked" True)
								(objSetData gSource "behavior" 'looting)
								)
					
						; If we have no destinations or randomly, we gate out
						(or (and (not (eq behavior 'enteredSystem)) (leq (random 1 100) 20))
								(not 
									; Compose a list of stations that we could go to.
									; We exclude the station that we're docked with and any
									; stations that don't have too many dock ports open.

									(setq allDests (filter (sysFindObject gSource "TAF +populated; -korolovShipping; -occupation;") theObj 
										(and (gr (objGetOpenDockingPortCount theObj) 1)
											(or (not dockedAt) (not (eq dockedAt theObj)))
											)
										))
									)
								)
							(block (gateObj)
								(setq gateObj (random (sysFindObject gSource "G -uncharted;")))
								(shpOrder gSource 'gate gateObj)
								(objSetData gSource "behavior" 'leavingSystem)
								)
								
						; Otherwise, we go to another station
						(block (destObj)
							(setq destObj (random allDests))
							(shpOrder gSource 'dock destObj)
							(shpOrder gSource 'waitForThreat (random 10 60))
							(objSetData gSource "behavior" 'docked)
							)
						)
						
					; If we were docked at an object that we just looted, then destroy the object
					(if (and (objGetData dockedAt "0010300c_marked")
							(ls (objGetProperty dockedAt 'mass) 2000)
							(not (objGetProperty dockedAt 'immutable))
							)
						(objDestroy dockedAt gSource)
						)
					)
			</OnOrdersCompleted>
		</Events>
	</ShipClass>
	
<!-- BASE CLASSES -->
	
	<!-- Commonwealth Station Base Class
	
	USAGE: Commonwealth stations should inherit from this class. Derived classes
		should manually call OnCreate and OnDestroy in case they need to override
		those events.
	
	-->
	
	<Type unid="&baCommonwealthStation;">
		<Events>
			<OnDestroy>
				(intCommonwealthOnDestroy)
			</OnDestroy>
		</Events>
	</Type>

<!-- RESOURCES -->

	<Image UNID="&rsCommonwealthArmoredColony;"	bitmap="Resources\CommonwealthColonyArmored.jpg" bitmask="Resources\CommonwealthColonyArmoredMask.bmp"  loadOnUse="true"/>
	<Image UNID="&rsCommonwealthColony;"		bitmap="Resources\CommonwealthColony.jpg" bitmask="Resources\CommonwealthColonyMask.bmp"  loadOnUse="true"/>
	<Image UNID="&rsCommonwealthMedicalColony;"	bitmap="Resources\CommonwealthMedicalColony.jpg" bitmask="Resources\CommonwealthMedicalColonyMask.bmp"  loadOnUse="true"/>
	<Image UNID="&rsCommonwealthResidentials;"	bitmap="Resources\CommonwealthResidentials.jpg" bitmask="Resources\CommonwealthResidentialsMask.bmp"  loadOnUse="true"/>
	<Image UNID="&rsCommonwealthSettlement;"	bitmap="Resources\CommonwealthSettlement.jpg" bitmask="Resources\CommonwealthSettlementMask.bmp"  loadOnUse="true"/>
	<Image UNID="&rsCommonwealthSlumsImage;"	bitmap="Resources\CommonwealthSlums.jpg" bitmask="Resources\CommonwealthSlumsMask.bmp"  loadOnUse="true"/>

</TranscendenceModule>
