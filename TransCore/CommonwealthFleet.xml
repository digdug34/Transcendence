<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>
	
<!--

PLAYER DATA

	fleetLevel:		Fleet level (1-6)
	fleetXP:		Fleet experience points

-->
	
	<Type unid="&unidCommonwealthFleet;">
		<Events>
			<GetGlobalPlayerPriceAdj>
				(block (rank)
					(setq rank (objGetData gPlayerShip 'fleetLevel))

					(switch
						;	Only at Fleet stations/ships

						(not (objHasAttribute aProviderObj 'commonwealthFleet))
							Nil

						;	Refuel is free at level 3 or higher

						(eq aService 'priceToRefuel)
							(switch
								(geq rank 3)	0
								Nil
								)

						;	Armor repair and device installation is free at 
						;	level 4 or higher

						(or (eq aService 'priceToRepairArmor)
								(eq aService 'priceToInstallDevice)
								(eq aService 'priceToRemoveDevice)
								)
							(switch
								(geq rank 4)	0
								Nil
								)

						;	No adjustment
						
						Nil
						)
					)
			</GetGlobalPlayerPriceAdj>
		</Events>
	</Type>

	<!-- Ares Campaign Ribbon -->

	<ItemType UNID="&itAresCampaignRibbon;"
			name=				"Ares Campaign Ribbon"
			level=				"7"
			value=				"50"
			mass=				"1"
			frequency=			"rare"
			numberAppearing=	"1"
			attributes=			"Consumable; NotForSale"

			description=		"The Commonwealth Fleet awards this ribbon to all who have been in combat against the Ares Orthodoxy."

			sortName=			"medal, Ares Campaign Ribbon"
			>

		<Image imageID="&rsItems1;" imageX="0" imageY="288" imageWidth="96" imageHeight="96"/>
	</ItemType>

	<!-- R5B deflector -->

	<ItemType UNID="&itR5BDeflector;"
			name=				":an R5-B deflector"
			level=				"7"
			value=				"45000"
			mass=				"3500"
			frequency=			"rare"
			attributes=			"MajorItem; Military; Specialty"

			description=		"Commonwealth Fleet labs created this variant of the R5 for its new Britannia-class gunships."
			>

		<Image imageID="&rsItems1;" imageX="192" imageY="0" imageWidth="96" imageHeight="96"/>

		<Shields
				hitPoints=		"220"
				hpBonus=		"  +0,  +0,  +0,  +0, +75, +25"
				regen=			"40"
				depletionDelay=	"360"
				powerUse=		"550"
				/>

	</ItemType>

	<!-- NM900 external missile pod -->

	<ItemType UNID="&itNM900MissilePod;"
			name=				"NM900 external missile pod"
			level=				"7"
			value=				"4200"
			mass=				"1000"
			frequency=			"rare"
			attributes=			"Disposable; MajorItem; Military; NAMI; Specialty"

			charges=			"36"
			massBonusPerCharge=	"40" 
			valueBonusPerCharge="120"

			description=		"This external pod is loaded with thirty-six XM900 nuclear missiles and can be installed without the aid of a station."
			>

		<Image imageID="&rsItemsNAMI4;" imageX="288" imageY="0" imageWidth="96" imageHeight="96"/>

		<Weapon
				type=				"missile"
				launcher=			"true"
				fireRate=			"30"
				powerUse=			"50"
				charges=			"true"

				deviceSlots=		"0"
				external=			"true"
				
				missileSpeed=		"40"
				hitPoints=			"20"
				lifetime=			"120"
				maneuverRate=		"9"

				effect=				"&efMissileNAMI;"
				hitEffect=			"&efThermoFragmentExplosion;"
				sound=				"&snMissileLauncher;"
				>

			<Fragment 
					count=			"1"
					type=			"radius"

					damage=			"thermo:7d24; momentum6; WMD7"
					minRadius=		"1"
					maxRadius=		"4"
					missileSpeed=	"0"
					
					hitEffect=		"&efThermoFragmentHit;"
					>
			</Fragment>
		</Weapon>
		
		<Invoke>
			(intAutoInstall gSource gItem)
		</Invoke>

		<Events>
			<Reload>
				; Reloads the pod with missiles
				(objSetItemCharges gSource gItem 36)
			</Reload>
		</Events>
	</ItemType>

	<!-- Lamplighter Archcannon -->

	<ItemType UNID="&itLamplighter;"
			name=				"Lamplighter archcannon"
			level=				"10"
			value=				"950000"
			mass=				"5500"
			frequency=			"notrandom"
			attributes=			"MajorItem; Military"

			description=		"Commissioned by Admiral Decker, this Commonwealth secret weapon is arguably the most powerful weapon created by humans."
			>

		<Image imageID="&rsItems10;" imageX="96" imageY="192" imageWidth="96" imageHeight="96"/>

		<Weapon
				type=				"missile"

				damage=				"antimatter:10d12; WMD:5"
				fireRate=			"16"
				missileSpeed=		"50"
				lifetime=			"60"
				hitPoints=			"30"
				powerUse=			"2000"

				effect=				"&efLamplighterProjectile;"
				sound=				"&snRecoillessCannon;"
				>
		</Weapon>

	</ItemType>

	<!-- Project Lamplighter Prototype -->

	<ItemType UNID="&itLamplighterPrototype;"
			name=				"Project Lamplighter prototype"
			level=				"10"
			value=				"400000"
			mass=				"5500"
			frequency=			"notrandom"
			unknownType=		"&itUnknownLamplighterPrototype;"
			attributes=			"lamplighterPrototype, majorItem, military, questItem"

			description=		"This prototype is designed to test the antimatter blast chamber of the Project Lamplighter weapon."
			>

		<Image imageID="&rsItems10;" imageX="0" imageY="192" imageWidth="96" imageHeight="96"/>

		<Weapon
				type=				"missile"
				failureChance=		"10"

				damage=				"antimatter:6d12; WMD:5"
				fireRate=			"15"
				missileSpeed=		"60"
				lifetime=			"40"
				hitPoints=			"15"
				powerUse=			"3000"

				effect=				"&efLamplighterProjectile;"
				sound=				"&snRecoillessCannon;"
				>
		</Weapon>

	</ItemType>

	<!-- Lamplighter data ROM -->

	<ItemType UNID="&itLamplighterDataROM;"
			name=				"unmarked data ROM"
			level=				"7"
			value=				"0"
			frequency=			"notrandom"
			mass=				"1"
			attributes=			"cannotOrder, consumable, info, lamplighterDataROM, notForSale, questItem"

			description=		"This unmarked ROM contains what looks like experimental data. It contains millions of data points collected over several years; their meaning and purpose is unknown."
			>

		<Image imageID="&rsItems1;" imageX="192" imageY="96" imageWidth="96" imageHeight="96"/>
	</ItemType>

	<!-- Unknown Prototype -->

	<ItemType UNID="&itUnknownLamplighterPrototype;"
			name=				"unknown prototype weapon"
			virtual=			"true"
			level=				"10"
			value=				"100000"

			description=		"This is weapon prototype of some kind. Its markings suggest that it was created by the Commonwealth Fleet."

			attributes=			"unknown"
			>

		<Names>weapon prototype marked "Alpha"; weapon prototype marked "Beta"; weapon prototype marked "Gamma";
			weapon prototype marked "Delta"; weapon prototype marked "Epsilon"; weapon prototype marked "Omega";
			weapon prototype marked "0.1"; weapon prototype marked "X17"; weapon prototype marked "Trinity";
			weapon prototype marked "Halifax"; weapon prototype marked "Test No. 6"; weapon prototype marked "596";
			weapon prototype marked "Hurricane"; weapon prototype marked "Ivy Mike"; weapon prototype marked "Castle Bravo";
			weapon prototype marked "Tsar Bomba"; weapon prototype marked "Smiling Buddha"; weapon prototype marked "RDS-37"
		</Names>

	</ItemType>
	
	<!-- Damage Control Party -->

	<ItemType UNID="&vtDamageControlParty;"
			name=				"(damage control party)"
			level=				"10"
			virtual=			"true"
			>

		<RepairerDevice
				regen=			"10,10,10, 7, 7,  7, 5, 5, 5, 4"
				powerUse=		"50"
				/>

	</ItemType>

<!-- SHIP CLASSES -->

	<!-- Aquila-class Cruiser -->

	<ShipClass UNID="&scAquilaCruiser;"
			manufacturer=		"Pacific Defense Corporation"
			class=				"Aquila"
			type=				"cruiser"
			defaultSovereign=	"&svCommonwealthFleet;"

			size=				"220"
			mass=				"26000"
			cargoSpace=			"1000"
			thrustRatio=		"1"
			maxSpeed=			"16"

			cyberDefenseLevel=	"8"
			explosionType=		"&vtThermoExplosion3;"

			attributes=			"capitalShip, commonwealth, commonwealthFleet, commonwealthMilitary, genericClass"
			>

		<!-- Configuration -->
		
		<Armor
			armorID=			"&itP210HexphaseArmor;"
			count=				"16"
			/>
		
		<Devices>
			<Device deviceID="&itStarCannon;" secondaryWeapon="true" minFireArc="355" maxFireArc="175" posAngle="90" posRadius="24" posZ="8"/>
			<Device deviceID="&itStarCannon;" secondaryWeapon="true" minFireArc="160" maxFireArc="5" posAngle="-90" posRadius="24" posZ="8"/>
			<Device deviceID="&itNAMIHeavyLauncher;" omnidirectional="true"/>
			<Device deviceID="&itR9Deflector;"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"3"
			rotationAccel=		"0.5"
			/>

		<Interior>
			<Compartment name="interior"
					hitPoints=	"200"
					/>
			
			<Compartment name="main drive"
					type=		"mainDrive"
					hitPoints=	"100"

					posX=		"-75"
					posY=		"0"
					sizeX=		"42"
					sizeY=		"56"
					/>
		</Interior>

		<Image imageID="&rsAquila;" imageWidth="210" imageHeight="210"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="168"	posRadius="94"	posZ="-20"	rotation="180"	effect="&efMainThrusterLarge;"/>
			<Effect type="thrustMain"		posAngle="-168"	posRadius="94"	posZ="-20"	rotation="180"	effect="&efMainThrusterLarge;"/>
			<Effect type="thrustMain"		posAngle="180"	posRadius="94"	posZ="-5"	rotation="180"	effect="&efMainThrusterLarge;"/>
		</Effects>

		<Items>
			<Item count="4d20" item="&itM2Missile;"/>
		</Items>

		<AISettings
			fireRateAdj=		"30"
			fireAccuracy=		"95"
			perception=			"4"

			combatStyle=		"standOff"
			/>

	</ShipClass>
	
	<!-- CSC Base Class
	
	EXTRA DATA
	
	behavior:			Ship's current behavior
							Nil					= holding position and available for missions
							'defendingCritical	= CSC is being attack by powerful enemy
							'moving				= CSC is moving to a new position
							
	disableDefense:		If TRUE, then we don't deploy defenders (we use this when we want to
						let the player handle it).

	squadron:			Entries for each ship in the CSC's squadron.
							Each entry in the squadron is a list:
								0: objID
								1: ship class
								2: status:
									'home
									'deployed
									'destroyed
	
	targetObj:			Target to destroy. If the CSC is in 'defendingCritical mode, then this
						is the capital ship that is attacking it.
						
	-->

	<Type UNID="&baCSCBase;">
		<Events>
			<OnAttackedByPlayer>
				(block Nil
					(if (not (eq (shpGetOrder gSource) 'attackHold))
						(shpOrderImmediate gSource 'attackHold gPlayerShip 10)
						)
					)
			</OnAttackedByPlayer>

			<OnBehavior>
				(block (behavior attackerList)
					(setq behavior (objGetData gSource "behavior"))
					
					(switch
						(eq behavior 'defendingCritical)
							Nil
							
						(eq behavior 'moving)
							Nil

						(block (attackerList highValueEnemies)
							(switch
								; If we don't have anyone attacking us, then there is
								; nothing to do.
								(not (setq attackerList (sysFindObject gSource "sAEPX")))
									Nil
									
								; If we're not supposed to attack, then don't
								(objGetData gSource "disableDefense")
									Nil
									
								; If any of the attackers are level 9 or higher, then we need
								; help. Deploy some Britannias.
								(setq highValueEnemies (filter attackerList theObj (geq (objGetLevel theObj) 9)))
									(block (theTarget )
										(setq theTarget (random highValueEnemies))
										(objSetObjRefData gSource "targetObj" theTarget)
										(objRegisterForEvents gSource theTarget)

										(for i 1 6
											(block (theShip)
												(setq theShip (cscSquadronDeployShip gSource &scBritannia;))
												(if theShip
													(block Nil
														(shpOrder theShip 'attack theTarget)
														(shpOrder theShip 'attackNearestEnemy)
														(shpOrder theShip 'gate gSource)
														)
													)
												)
											)

										(objSetData gSource "behavior" 'defendingCritical)
										)
								)
							)
						)
					)
			</OnBehavior>

			<OnCreate>
				(block (squadronList)
					; Are we in a good spot? If not, then we give orders to move
					(fltOrderCheckPosition gSource)

					; Create the Britannia squadron
					(for i 1 6
						(cscSquadronCreateShip gSource &scBritannia;)
						)

					; Behavior event
					(sysAddObjRecurringTimerEvent 90 gSource "OnBehavior")
					)
			</OnCreate>

			<OnDestroy>
				(block (squadronList)
					; Destroy our squadron
					(setq squadronList (objGetData gSource "squadron"))
					(objSetData gSource "squadron" Nil)
					(enum squadronList theEntry
						(if (eq (item theEntry 2) 'home)
							(objDestroy (objGetObjByID (item theEntry 0)))
							)
						)
					
					; Commonwealth is mad too
					(intCommonwealthOnDestroy)

					; Military will execute the player
					(if (and gPlayerShip (eq aOrderGiver gPlayerShip))
						(intFleetCrime 3 (cat "the destruction of " (objGetName gSource 4)))
						)
					)
			</OnDestroy>

			<OnObjDestroyed>
				(block (behavior theID theEntry squadronList)
					(setq behavior (objGetData gSource "behavior"))
					
					(switch
						; See if we destroyed the target
						(and (eq behavior 'defendingCritical)
								(eq aObjDestroyed (objGetObjRefData gSource "targetObj"))
								)
							(block Nil
								(objSetData gSource "behavior" Nil)
								)
						
						; If the ship entered a stargate, then ignore it
						(eq aDestroyReason 'enteredStargate)
							Nil
						
						; See if this is one of our gunships	
						(setq theEntry (match (setq squadronList (objGetData gSource "squadron")) theEntry 
								(eq (item theEntry 0) (setq theID (objGetID aObjDestroyed)))
								))
							(block Nil
							
								; Mark the entry as destroyed
								(setq squadronList (map squadronList theEntry
									(if (eq (item theEntry 0) theID)
										(list theID (item theEntry 1) 'destroyed)
										theEntry
										)
									))
									
								(objSetData gSource "squadron" squadronList)
								
								;(dbgOutput theID ": Destroyed")
								)
						)
					)
			</OnObjDestroyed>

			<OnObjEnteredGate>
				(block (theID theEntry squadronList)
					(setq theID (objGetID aObj))
					
					(switch
						(not (setq theEntry (match (setq squadronList (objGetData gSource "squadron")) theEntry (eq (item theEntry 0) theID))))
							Nil
							
						(block Nil
							; Repair and reload the ship
							(intArmorRepairAll aObj 10)
							(shpRechargeShield aObj 1000)
							(objFireEvent aObj "Reload")
							
							; Suspend object
							(objSuspend aObj)
							
							; Mark the entry as home
							(setq squadronList (map squadronList theEntry
								(if (eq (item theEntry 0) theID)
									(list theID (item theEntry 1) 'home)
									theEntry
									)
								))
								
							(objSetData gSource "squadron" squadronList)

							;(dbgOutput theID ": Returned to carrier")
							)
						)
					)
			</OnObjEnteredGate>
			
			<OnOrdersCompleted>
				(block (behavior)
					(setq behavior (objGetData gSource "behavior"))
					(switch
						(eq behavior 'moving)
							(block Nil
								(objSetProperty gSource 'dockingEnabled True)
								(shpOrder gSource 'hold)
								(objSetData gSource "behavior" Nil)
								)

						(block Nil
							(shpOrder gSource 'hold)
							(objSetData gSource "behavior" Nil)
							)
						)
					)
			</OnOrdersCompleted>
		</Events>
	</Type>

	<!-- CSC Task Force
	
	GLOBAL DATA
	
	missionsAccepted:	Total missions accepted
	missionsCompleted:	Total missions completed successfully
	missionsFailed:		Total missions failed

	EXTRA DATA
	
	MissionID:			ID of current mission
	MissionStatus:		Current status of mission:
							Nil					= no mission in progress
							'inprogress			= mission in progress
							'success			= mission succeeded
							'failure			= mission failed

	PLAYER SHIP EXTRA
	
	fleetTFSuccess:		Total number of successful missions
	fleetTFFailure:		Total number of failed missions

	-->

	<ShipClass UNID="&scCSCTaskForce;"
			manufacturer=		"Earth Industries"
			class=				"Commonwealth Star Carrier"
			type=				""
			defaultSovereign=	"&svCommonwealthFleet;"

			attributes=			"capitalShip, commonwealth, commonwealthFleet, commonwealthMilitary, genericClass, fleetLaw, majorShip"
			inherit=			"&baCSCBase;"
			   
			size=				"400"
			mass=				"200000"
			thrustRatio=		"0.5"
			maxSpeed=			"2"
			cargoSpace=			"5000"
			cyberDefenseLevel=	"8"
			   
			explosionType=		"&vtPlasmaExplosion2;"

			dockScreen=			"Main"
			>

		<!-- Configuration -->
		
		<Armor
			armorID=			"&itP1000HexphaseArmor;"
			count=				"20"
			/>
		
		<Devices>
			<Device deviceID="&itTeV9Blaster;" secondaryWeapon="true" minFireArc="270" maxFireArc="90"  posAngle="0" posRadius="98" posZ="-5"/>
			<Device deviceID="&itTeV9Blaster;" secondaryWeapon="true" minFireArc="90"  maxFireArc="270" posAngle="180" posRadius="98" posZ="-5"/>
			<Device deviceID="&itTeV9Blaster;" secondaryWeapon="true" omnidirectional="true" posAngle="90" posRadius="98" posZ="-5"/>
			<Device deviceID="&itTeV9Blaster;" secondaryWeapon="true" omnidirectional="true" posAngle="270" posRadius="98" posZ="-5"/>
			
			<Device deviceID="&itMissileDefense;" omnidirectional="true" />
			<Device deviceID="&vtDamageControlParty;"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"1"
			rotationAccel=		"0.1"
			/>

		<Interior>
			<Compartment name="interior"
					hitPoints=	"600"
					/>
			
			<Compartment name="main drive"
					type=		"mainDrive"
					hitPoints=	"200"

					posX=		"-56"
					posY=		"0"
					sizeX=		"42"
					sizeY=		"60"
					/>
		</Interior>

		<Items>
			<Item				count="6d12"	item="&itPteracniumFuelRod;"/>
			
			<!-- Some upgrades for sale -->
			
			<RandomItem count="1d4" criteria="r -illegal; -notForSale; -notStandard; L:6-9;"		levelFrequency="systemLevel:ru|c|curv"/>
			
			<Item count="3d4"	item="&itBlastPlate;"/>
			<Item count="3d4"	item="&itP120HexphaseArmor;"/>
			<Item count="1d4"	item="&itStarCannon;"/>
			<Item count="1d4"	item="&itTeV9Blaster;"/>
			<Item count="1d4"	item="&itR1Deflector;"/>
			<Item count="1d4"	item="&itR5BDeflector;"/>
		</Items>

		<!-- Image and Effects -->

		<Image imageID="&rsCSC;" imageX="0" imageY="0" imageWidth="370" imageHeight="370" />

		<Effects>
			<Effect type="thrustMain"		posAngle="166"	posRadius="116"	posZ="-10"	rotation="180"	effect="&efMainThrusterLarge;"/>
			<Effect type="thrustMain"		posAngle="180"	posRadius="114"	posZ="-10"	rotation="180"	effect="&efMainThrusterLarge;"/>
			<Effect type="thrustMain"		posAngle="-166"	posRadius="116"	posZ="-10"	rotation="180"	effect="&efMainThrusterLarge;"/>
		</Effects>
			
		<DockingPorts>
			<Port posAngle="90"   posRadius="105"  posZ="0" />
			<Port posAngle="-90"  posRadius="105"  posZ="0" />

			<Port posAngle="45"   posRadius="105"  posZ="0"	bringToFront="*"/>
			<Port posAngle="135"  posRadius="105"  posZ="0"	bringToFront="*"/>
			<Port posAngle="225"  posRadius="105"  posZ="0"	bringToFront="*"/>
			<Port posAngle="315"  posRadius="105"  posZ="0"	bringToFront="*"/>
		</DockingPorts>

		<!-- AI and Behavior -->

		<AISettings
			fireRateAdj=		"10"
			fireAccuracy=		"95"
			perception=			"6"
			/>
		
		<Trade currency="credit" max="100000" replenish="5000">
			<Sell	criteria="m +commonwealth; +military; -illegal; -notForSale; -notStandard;" priceAdj="100" inventoryAdj="500" levelFrequency="systemLevel:ruc|c|cur"/>
			<Sell	criteria="*NU -Illegal; -ID; -NotForSale;"	priceAdj="100"/>
			
			<Refuel			criteria="f +BasicFuel; L:1-9;" priceAdj="90"/>
			<RepairArmor	criteria="a L:1-10;" priceAdj="100"/>
			<ReplaceArmor	criteria="a L:1-10;" priceAdj="100"/>
			<InstallDevice	criteria="d L:1-9;" priceAdj="100"/>
			<RemoveDevice	criteria="d L:1-9;" priceAdj="100"/>
		</Trade>

		<Events>
			<OnLoad>
				(block (
					(dataEntry (@ (typGetStaticData &stCSCTaskForceEncounter; 'CSCData) (objGetData gSource 'CSC)))
					)
					(objSetData gSource 'CSCData (eval dataEntry))
					)
			</OnLoad>
		</Events>

		<DockScreens>
			<Main backgroundID="none">
				<Display>
					<Image left="140" top="144" width="320" height="240" transparent="true">
						(@ (objGetData gSource 'CSCData) 'emblem)
					</Image>
				</Display>

				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDescTranslate gScreen 'descWelcome)
						</OnPaneInit>

						<Actions>
							<Action id="actionBridge" default="1">
								(scrShowScreen gScreen "Bridge")
							</Action>

							<Action id="actionFlightDeck">
								(scrShowScreen gScreen "FlightDeck")
							</Action>

							<Action id="actionDockServices">
								(rpgDockServices gPlayerShip {
									checkMilitaryID: True
									})
							</Action>

							<Action id="actionUndock" cancel="1">
								<Exit/>
							</Action>
						</Actions>
					</Default>
				</Panes>
			</Main>

			<Bridge
				name=			"Bridge"
				backgroundID=	"none"
				>

				<Display>
					<Image left="140" top="144" width="320" height="240" transparent="true">
						(@ (objGetData gSource 'CSCData) 'emblem)
					</Image>
				</Display>
				
				<Panes>
					<Default>
						<OnPaneInit>
							(switch
								(eq (objGetData gSource "CSC") "america")
									(scrSetDesc gScreen "You talk to the captain of the CSC America. \"The Ares have been ruthless. When we lost the CSC Europa, the damn Martians deliberately targeted the emergency capsules. We taught them a lesson after that, though: we torched several of their communes.\"")

								(eq (objGetData gSource "CSC") "india")
									(scrSetDesc gScreen "You talk to the captain of the CSC India. \"If you ever get back to the Commonwealth, you've got to tell them to send more ships. We're getting killed out here and I don't even know if anyone back home cares.\"")

								(eq (objGetData gSource "CSC") "atlantica")
									(scrSetDesc gScreen "You talk to the captain of the CSC Atlantica. \"This war has been tough on the troops. We've had to start scavenging for vital supplies. I'm not surprised that the discipline in some units has deteriorated.\"")

								(eq (objGetData gSource "CSC") "asia")
									(scrSetDesc gScreen "You talk to the captain of the CSC Asia. \"When the Antarctica went rogue, Admiral Decker just about pissed acid. He was furious! He took it as a personal betrayal.\"")

								(eq (objGetData gSource "CSC") "pacifica")
									(scrSetDesc gScreen "You talk to the captain of the CSC Pacifica. \"You ever meet a Martian? Not the meek little Syrtians&#x97;I mean the Ares clones. They all have this smug look of superiority that cranks me up. They look better in the crosshairs of TeV 9, that's for sure!\"")

								(scrSetDesc gScreen "The captain welcomes you aboard.")
								)
						</OnPaneInit>

						<Actions>
							<Action id="actionLeave" default="1" cancel="1">
								(scrShowScreen gScreen "Main")
							</Action>
						</Actions>
					</Default>
				</Panes>

			</Bridge>

			<FlightDeck
				name=			"Flight Deck"
				backgroundID=	"none"
				>

				<Display>
					<Image left="140" top="144" width="320" height="240" transparent="true">
						(@ (objGetData gSource 'CSCData) 'emblem)
					</Image>
				</Display>
				
				<Panes>
					<Default>
						<OnPaneInit>
							(block (behavior rank)
								(setq behavior (objGetData gSource "behavior"))
								(setq rank (objGetData gPlayerShip "fleetLevel"))
								
								(switch
									(eq behavior 'moving)
										(scrSetDesc gScreen
											"You are on the flight deck of " (objGetName gSource 0x04) ". "
											"The ship is on maneuvers and the XO is giving orders to the astrogator and the sensor chief."
											)
											
									(eq rank 1)
										(scrSetDesc gScreen
											"The flight deck of " (objGetName gSource 0x04) 
											" hums with the activity of men and women working at terminals and holocharts. "
											"The XO is giving orders to a squadron out on a mission."
											)

									(scrSetDesc gScreen
										"You are on the flight deck of " (objGetName gSource 0x04) ". "
										"Men and women work at terminals planning missions and communicating with squadrons on patrol. "
										"The XO is near a holochart, listening to a report."
										)
									)
								)
						</OnPaneInit>

						<Actions>
							<Action id="actionTalk" default="1">
								(block (
									(behavior (objGetData gSource "behavior"))
									(rank (objGetData gPlayerShip "fleetLevel"))
									)
									(switch
										(eq behavior 'moving)
											(scrShowPane gScreen "ShipMoving")
										
										(rpgMissionAssignment {
											missionCriteria: (cat "n +cscTaskForce; +rank" (int rank) "; =" (sysGetLevel) ";")
											noMissionTextID: 'descNoMissions
											})
										)
									)
							</Action>

							<Action id="actionLeave" cancel="1">
								(scrShowScreen gScreen "Main")
							</Action>
						</Actions>
					</Default>
					
					<ShipMoving>
						<OnPaneInit>
							(scrSetDesc gScreen
								"The XO is too busy to talk to you right now. He waves you away while he concentrates on the maneuvers."
								)
						</OnPaneInit>
						
						<Actions>
							<Action id="actionLeave" default="1" cancel="1">
								(scrShowScreen gScreen "Main")
							</Action>
						</Actions>
					</ShipMoving>
				</Panes>
			</FlightDeck>

		</DockScreens>

		<Language>
			<Text id="actionBridge">"[B]ridge"</Text>
			<Text id="actionFlightDeck">"[F]light Deck"</Text>
			<Text id="actionDockServices">"[D]ock Services"</Text>
			<Text id="actionUndock">"[U]ndock"</Text>
			<Text id="actionLeave">"[L]eave"</Text>
			<Text id="actionTalk">"Talk to E[x]ecutive Officer"</Text>

			<Text id="descWelcome">
				(cat
					"You are in the docking bay of the " (objGetName gSource) "."
					)
			</Text>

			<Text id="descNoMissions">
				(cat
					"\"Sorry, there are no missions available for you.\""
					)
			</Text>
		</Language>

	</ShipClass>

	<!-- CSC Hospital -->

	<ShipClass UNID="&scCSCHospital;"
			manufacturer=		"Earth Industries"
			class=				"Commonwealth Star Carrier"
			type=				""

			attributes=			"capitalShip, commonwealth, commonwealthFleet, commonwealthMilitary, fleetLaw, majorShip"
			inherit=			"&baCSCBase;"
			   
			size=				"400"
			mass=				"200000"
			cargoSpace=			"5000"
			thrustRatio=		"0.5"
			maxSpeed=			"2"
			cyberDefenseLevel=	"6"
			   
			explosionType=		"&vtPlasmaExplosion2;"

			dockScreen=			"Main"
			>

		<!-- Configuration -->
		
		<Armor
			armorID=			"&itP1000HexphaseArmor;"
			count=				"20"
			/>
		
		<Devices>
			<Device deviceID="&itTeV9Blaster;" secondaryWeapon="true" minFireArc="270" maxFireArc="90"  posAngle="0" posRadius="98" posZ="-5"/>
			<Device deviceID="&itTeV9Blaster;" secondaryWeapon="true" minFireArc="90"  maxFireArc="270" posAngle="180" posRadius="98" posZ="-5"/>
			<Device deviceID="&itTeV9Blaster;" secondaryWeapon="true" omnidirectional="true" posAngle="90" posRadius="98" posZ="-5"/>
			<Device deviceID="&itTeV9Blaster;" secondaryWeapon="true" omnidirectional="true" posAngle="270" posRadius="98" posZ="-5"/>
			
			<Device deviceID="&itMissileDefense;" omnidirectional="true" />
			<Device deviceID="&vtDamageControlParty;"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"1"
			rotationAccel=		"0.1"
			/>

		<Interior>
			<Compartment name="interior"
					hitPoints=	"400"
					/>
			
			<Compartment name="main drive"
					type=		"mainDrive"
					hitPoints=	"200"

					posX=		"-56"
					posY=		"0"
					sizeX=		"42"
					sizeY=		"60"
					/>
		</Interior>
		
		<Items>
			<Item				count="6d12"	item="&itPteracniumFuelRod;"/>
			
			<!-- Some upgrades for sale -->
			
			<RandomItem count="1d3" criteria="r -illegal; -notForSale; -notStandard; L:6-8;"		levelFrequency="systemLevel:ru|c|curv"/>
			
			<Item count="3d4"	item="&itBlastPlate;"/>
			<Item count="3d4"	item="&itP120HexphaseArmor;"/>
			<Item count="1d4"	item="&itTeV9Blaster;"/>
			<Item count="1d4"	item="&itR1Deflector;"/>
		</Items>

		<Image imageID="&rsCSC;" imageX="0" imageY="0" imageWidth="370" imageHeight="370" />

		<Effects>
			<Effect type="thrustMain"		posAngle="166"	posRadius="116"	posZ="-10"	rotation="180"	effect="&efMainThrusterLarge;"/>
			<Effect type="thrustMain"		posAngle="180"	posRadius="114"	posZ="-10"	rotation="180"	effect="&efMainThrusterLarge;"/>
			<Effect type="thrustMain"		posAngle="-166"	posRadius="116"	posZ="-10"	rotation="180"	effect="&efMainThrusterLarge;"/>
		</Effects>
			
		<DockingPorts>
			<Port posAngle="90"   posRadius="105"  posZ="0" />
			<Port posAngle="-90"  posRadius="105"  posZ="0" />

			<Port posAngle="45"   posRadius="105"  posZ="0"	bringToFront="*"/>
			<Port posAngle="135"  posRadius="105"  posZ="0"	bringToFront="*"/>
			<Port posAngle="225"  posRadius="105"  posZ="0"	bringToFront="*"/>
			<Port posAngle="315"  posRadius="105"  posZ="0"	bringToFront="*"/>
		</DockingPorts>

		<AISettings
			fireRateAdj=		"15"
			fireAccuracy=		"95"
			perception=			"4"
			/>

		<Trade currency="credit" max="100000" replenish="5000">
			<Sell	criteria="m +commonwealth; +military; -illegal; -notForSale; -notStandard;" priceAdj="100" inventoryAdj="200" levelFrequency="systemLevel:ruc|c|cur"/>
			<Sell	criteria="*NU -Illegal; -ID; -NotForSale;"	priceAdj="100"/>
			
			<Refuel			criteria="f +BasicFuel; L:1-9;" priceAdj="90"/>
			<RepairArmor	criteria="a L:1-9;" priceAdj="100"/>
			<ReplaceArmor	criteria="a L:1-9;" priceAdj="100"/>
			<InstallDevice	criteria="d L:1-8;" priceAdj="100"/>
			<RemoveDevice	criteria="d L:1-8;" priceAdj="100"/>
		</Trade>
		
		<Events>
			<OnLoad>
				(switch
					(eq (objGetData gSource 'CSC) 'arctica)
						(objSetData gSource 'CSCData {
							name: "CSC Arctica"
							emblem: (resCreateImageDesc &rsFleetEmblems; 960 0 320 240)
							})
							
					(eq (objGetData gSource 'CSC) 'sahara)
						(objSetData gSource 'CSCData {
							name: "CSC Sahara"
							emblem: (resCreateImageDesc &rsFleetEmblems; 640 480 320 240)
							})
					)
			</OnLoad>
		</Events>

		<StaticData>
			<arcticaCaptainWelcome>
				(
					"The captain of the CSC Arctica welcomes you aboard: \"How are things going back in the Commonwealth? I haven't been to St. Katharine's in more than five years&#x97;had an amazing time at this little bar in the inner system. You really should check it out&#x97;if you make it back, I mean.\""
					)
			</arcticaCaptainWelcome>

			<arcticaGiftTable>
				(	; donation	item						count	unique
					(10000		&itPlasmaShieldGenerator;	1		'Gift1)
					(5000		&itInvincibleDeflector;		1		'Gift2)
					(2500		&itR5Deflector;				1		'Gift3)
					(1250		&itEMPImmuneCoating;		4		'Gift4)
					(0			&itKobeWater;				1		Nil)
					)
			</arcticaGiftTable>

			<saharaCaptainWelcome>
				(
					"The captain of the CSC Sahara welcomes you aboard: \"I hope you will be able to help our good doctor to obtain medical supplies. This damn war has made more invalids than heroes.\""
					)
			</saharaCaptainWelcome>

			<saharaGiftTable>
				(	; donation	item						count	unique
					(10000		&itMammoth100Deflector;		1		'Gift1)
					(5000		&itBlueEtheriumCrystal;		1		'Gift2)
					(2500		&itPatchSpider;				1		'Gift3)
					(1250		&itR1Deflector;				1		'Gift4)
					(0			&itEuropanIceVodka;			1		Nil)
					)
			</saharaGiftTable>
		</StaticData>

		<DockScreens>
			<Main backgroundID="none">
				<Display>
					<Image left="140" top="144" width="320" height="240" transparent="true">
						(@ (objGetData gSource 'CSCData) 'emblem)
					</Image>
				</Display>
				
				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDescTranslate gScreen 'descWelcome)
						</OnPaneInit>

						<Actions>
							<Action id="actionBridge" default="1">
								(block Nil
									(scrShowScreen gScreen "Bridge")
								
									; If see if we got promoted
									(if (intFleetPromotion)
										(scrShowScreen gScreen "&dsFleetPromotion;")
										)
									)
							</Action>

							<Action id="actionInfirmary">
								(scrShowScreen gScreen "Infirmary")
							</Action>

							<Action id="actionDockServices">
								(rpgDockServices gPlayerShip {
									checkMilitaryID: True
									})
							</Action>

							<Action id="actionUndock" cancel="1">
								<Exit/>
							</Action>
						</Actions>
					</Default>
				</Panes>

			</Main>

			<Bridge
				name=			"Bridge"
				backgroundID=	"none"
				>

				<Display>
					<Image left="140" top="144" width="320" height="240" transparent="true">
						(@ (objGetData gSource 'CSCData) 'emblem)
					</Image>
				</Display>
				
				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen (intRandomMessage gSource (cat (objGetData gSource "CSC") "CaptainWelcome") "arcticaCaptainWelcome"))
						</OnPaneInit>

						<Actions>
							<Action id="actionLeave" default="1" cancel="1">
								(scrShowScreen gScreen "Main")
							</Action>
						</Actions>
					</Default>
				</Panes>

			</Bridge>

			<Infirmary
				name=			"Infirmary"
				backgroundID=	"none"
				>

				<Display>
					<Image left="140" top="144" width="320" height="240" transparent="true">
						(@ (objGetData gSource 'CSCData) 'emblem)
					</Image>
				</Display>
				
				<Panes>
					<Default
							desc=	"You are in the main infirmary of a Commonwealth Star Carrier. Sleep-deprived technicians attend hundreds of patients in their rejuv tanks, mostly oblivious to the insistent medical alarms. The smell of blood, wounds, and antiseptics smother you.">

						<Actions>
							<Action id="actionTalkMedical" default="1">
								(block Nil
									; See if the player has any medical supplies
									(setq gItem (objGetItems gPlayerShip "*U +Meds; -questItem; -notForSale;"))

									(if gItem
										(scrShowPane gScreen "SellMedicalItems")
										(scrShowPane gScreen "NoMedicalItems")
										)
									)
							</Action>

							<!--
							<Action name="Talk to patient" key="P">
								</Action>
								-->

							<Action id="actionLeave" cancel="1">
								(scrShowScreen gScreen "Main")
							</Action>
						</Actions>
					</Default>

					<NoMedicalItems
							desc=	"The Medical Officer complains about how hard it is to get medical supplies this deep in space. &quot;We're getting killed out here fighting the Ares and this is how the Commonwealth thanks us&#x97;no supplies, no reinforcements, nothing!&quot;">

						<Actions>
							<Action id="actionLeave" default="1" cancel="1">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>

					</NoMedicalItems>

					<SellMedicalItems>
						<OnPaneInit>
							(block (medicalItem)
								; Figure out how much all the supplies cost
								(setq gCost 0)
								(enum gItem medicalItem
									(setq gCost 
										(add gCost 
											; Offer 25% more
											(divide (multiply 125 (itmGetPrice medicalItem 'credit) (itmGetCount medicalItem)) 100)
											)
										)
									)

								; Set the description
								(if (eq (count gItem) 1)
									; Only one item
									(scrSetDesc gScreen 
										"\"Welcome to the Infirmary, %sir%! We are in desperate need of medical supplies. "
										"I'm prepared to offer you " gCost " credits for the " (itmGetName (item gItem 0) 16) " in your cargo hold. "
										"What do you say?\""
										)

									; Multiple items
									(block (medicalItem itemListDesc)
										(enum gItem medicalItem
											(if itemListDesc
												(setq itemListDesc (cat itemListDesc ", " (itmGetName medicalItem 8)))
												(setq itemListDesc (cat "(" (itmGetName medicalItem 8)))
												)
											)

										(setq itemListDesc (cat itemListDesc ")"))

										(scrSetDesc gScreen 
											"\"Welcome to the Infirmary, %sir%! We are in desperate need of medical supplies. "
											"I'm prepared to offer you " gCost " credits for all the medical items in your cargo hold: " itemListDesc 
											". What do you say?\""
											)
										)
									)
								)
						</OnPaneInit>

						<Actions>
							<Action id="actionSell" default="1">
								(block (medicalItem)
									; Remove the items from the cargo hold
									(enum gItem medicalItem
										(block Nil
											(objRemoveItem gPlayerShip medicalItem)
											(plyRecordSellItem gPlayer medicalItem 
												(divide (multiply 125 (itmGetPrice medicalItem 'credit) (itmGetCount medicalItem)) 100)
												)
											)
										)

									; Pay the player
									(plyCredit gPlayer gCost)

									; Done
									(scrShowPane gScreen "DoneSelling")
									)
							</Action>

							<Action id="actionDonate">
								(block (medicalItems)
									; Remove the items from the cargo hold
									(enum gItem medicalItem
										(objRemoveItem gPlayerShip medicalItem)
										)
										
									; Keep track of how much we donate
									(typIncGlobalData &svCommonwealthFleet; "medsDonated" gCost)

									; Player gets a gift depending on how much she donated
									(scrShowPane gScreen "Donate")
									)
							</Action>

							<Action id="actionLeave" cancel="1">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>

					</SellMedicalItems>

					<DoneSelling
							desc=	"&quot;Thank you, those supplies are really going to help these troopers.&quot;">

						<Actions>
							<Action id="actionLeave" default="1" cancel="1">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>

					</DoneSelling>

					<Donate>
						<OnPaneInit>
							(block (gift giftTable fleetXP xpGain maxGain)
								; Get the gift table
								(setq giftTable (objGetStaticData gSource (cat (objGetData gSource "CSC") "GiftTable")))
								(if (not giftTable)
									(setq giftTable (objGetStaticData gSource "arcticaGiftTable"))
									)

								; Find the appropriate gift based on the donation. The donation amount
								; must be greater than the minimum for the gift and the gift must have
								; not been given before (or the gift must not be unique).
								(setq gift Nil)
								(enumwhile giftTable (not gift) thisEntry
									(if (and (geq gCost (item thisEntry 0))
											(or (not (item thisEntry 3)) (not (objGetData gSource (item thisEntry 3))))
											)
										(block Nil
											(setq gift (itmCreate (item thisEntry 1) (item thisEntry 2)))

											; Do not give this gift again
											(if (item thisEntry 3)
												(objSetData gSource (item thisEntry 3) True)
												)
											)
										)
									)

								; Describe the gift
								(scrSetDesc gScreen (cat "\"Your generosity humbles me! When I was posted in the front-lines I came across " (itmGetName gift 8) ". I would be honored if you would accept it as a gift.\""))

								; Give the gift to the player
								(objAddItem gPlayerShip gift)

								; Figure out how much experience we could gain. We cannot gain more than
								; 200xp or xp beyond 600 (Master Sergeant).
								(setq fleetXP (objGetData gPlayerShip "fleetXP"))
								(switch
									(geq fleetXP 600)
										(setq maxGain 0)

									(geq fleetXP 400)
										(setq maxGain (subtract 600 fleetXP))

									(setq maxGain 200)
									)

								; Player gains experience at the rate of 1 xp per 10 credits
								; up to a maximum
								(setq xpGain (divide gCost 10))
								(if (gr xpGain maxGain)
									(setq xpGain maxGain)
									)

								(objIncData gPlayerShip "fleetXP" xpGain)
								)
						</OnPaneInit>

						<Actions>
							<Action id="actionDone" default="1" cancel="1">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</Donate>

				</Panes>

			</Infirmary>

		</DockScreens>

		<Language>
			<Text id="actionBridge">"[B]ridge"</Text>
			<Text id="actionInfirmary">"[I]nfirmary"</Text>
			<Text id="actionDockServices">"[D]ock Services"</Text>
			<Text id="actionUndock">"[U]ndock"</Text>
			<Text id="actionLeave">"[L]eave"</Text>
			<Text id="actionTalkMedical">"Talk to [M]edical Officer"</Text>
			<Text id="actionSell">"[S]ell Items"</Text>
			<Text id="actionDonate">"[D]onate Items"</Text>

			<Text id="descWelcome">
				(cat
					"You are in the docking bay of the " (objGetName gSource) "."
					)
			</Text>
		</Language>

	</ShipClass>

	<!-- Aurochs Transport -->

	<ShipClass UNID="&scAurochs;"
			manufacturer=		"Pacific Defense Corporation"
			class=				"Aurochs"
			type=				"transport"
			defaultSovereign=	"&svCommonwealthFleet;"

			size=				"65"
			mass=				"2000"
			cargoSpace=			"5600"
			thrustRatio=		"0.8"
			maxSpeed=			"15"

			explosionType=		"&vtBlastExplosion3;"

			attributes=			"freighter, genericClass"
			>

		<Armor>
			<ArmorSection start="345" span="30" armorID="&itP120HexphaseArmor;" />
			<ArmorSection start="315" span="30" armorID="&itP120HexphaseArmor;" />
			<ArmorSection start="285" span="30" armorID="&itP120HexphaseArmor;" />
			<ArmorSection start="255" span="30" armorID="&itP120HexphaseArmor;" />
			<ArmorSection start="225" span="30" armorID="&itP120HexphaseArmor;" />
			<ArmorSection start="195" span="30" armorID="&itP120HexphaseArmor;" />
			<ArmorSection start="165" span="30" armorID="&itP120HexphaseArmor;" />
			<ArmorSection start="135" span="30" armorID="&itP120HexphaseArmor;" />
			<ArmorSection start="105" span="30" armorID="&itP120HexphaseArmor;" />
			<ArmorSection start="75"  span="30" armorID="&itP120HexphaseArmor;" />
			<ArmorSection start="45"  span="30" armorID="&itP120HexphaseArmor;" />
			<ArmorSection start="15"  span="30" armorID="&itP120HexphaseArmor;" />
		</Armor>

		<Devices>
			<Device deviceID="&itTeV9Blaster;" omnidirectional="true" posAngle="180" posRadius="12" posZ="10"/>
			<Device deviceID="&itR5Deflector;"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"4.0"
			rotationAccel=		"0.5"
			/>

		<Interior>
			<Compartment name="interior"
					hitPoints=	"30"
					/>
			
			<Compartment name="main drive"
					type=		"mainDrive"
					hitPoints=	"70"

					posX=		"-31"
					posY=		"0"
					sizeX=		"28"
					sizeY=		"42"
					/>
			
			<Compartment name="cargo containers"
					type=		"cargo"
					hitPoints=	"50"

					posX=		"10"
					posY=		"0"
					sizeX=		"40"
					sizeY=		"40"
					/>
		</Interior>
		 
		<Image imageID="&rsAurochsHD;" imageWidth="96" imageHeight="96"		rotationCount="120" rotationColumns="12"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="157"	posRadius="43"	posZ="0"	rotation="180"	effect="&efMainThrusterLarge;"/>
			<Effect type="thrustMain"		posAngle="180"	posRadius="42"	posZ="5"	rotation="180"	effect="&efMainThrusterLarge;"/>
			<Effect type="thrustMain"		posAngle="-157"	posRadius="43"	posZ="0"	rotation="180"	effect="&efMainThrusterLarge;"/>
		</Effects>

		<Items>
			<Item count="1d12" item="&itXenotiteFuelRod;"/>
		</Items>

		<Names noArticle="true">
			Aurochs Alpha-%0%0; Aurochs Beta-%0%0; Aurochs Gamma-%0%0;
			Aurochs Delta-%0%0; Aurochs Epsilon-%0%0; Aurochs Zeta-%0%0;
			Aurochs Eta-%0%0; Aurochs Theta-%0%0; Aurochs Iota-%0%0;
			Aurochs Kappa-%0%0; Aurochs Lambda-%0%0; Aurochs Mu-%0%0;
			Aurochs Nu-%0%0; Aurochs Xi-%0%0; Aurochs Omicron-%0%0;
			Aurochs Pi-%0%0; Aurochs Rho-%0%0; Aurochs Sigma-%0%0;
			Aurochs Tau-%0%0; Aurochs Upsilon-%0%0; Aurochs Phi-%0%0;
			Aurochs Chi-%0%0; Aurochs Psi-%0%0; Aurochs Omega-%0%0
		</Names>

		<AISettings
			fireRateAdj=		"20"
			fireAccuracy=		"90"
			perception=			"4"
			
			combatStyle=		"standOff"
			/>

	</ShipClass>


	<!-- Britannia-class Heavy Gunship -->

	<ShipClass UNID="&scBritannia;"
			manufacturer=		"Pacific Defense Corporation"
			class=				"Britannia"
			type=				"heavy gunship"
			defaultSovereign=	"&svCommonwealthFleet;"

			mass=				"120"
			cargoSpace=			"50"
			thrustRatio=		"9.0"
			maxSpeed=			"22"

			attributes=			"commonwealth, commonwealthMilitary, commonMilitary, genericClass"
			>

		<Armor>
			<ArmorSection start="315" span="90" armorID="&itP120HexphaseArmor;"/>
			<ArmorSection start="225" span="90" armorID="&itP120HexphaseArmor;"/>
			<ArmorSection start="135" span="90" armorID="&itP120HexphaseArmor;"/>
			<ArmorSection start="45"  span="90" armorID="&itP120HexphaseArmor;"/>
		</Armor>

		<Devices>
			<Device deviceID="&itStarCannon;"/>
			<Device deviceID="&itR5BDeflector;"/>
			<Device deviceID="&itNM900MissilePod;"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"9.0"
			rotationAccel=		"2.0"
			/>

		<Items>
			<Item count="2d6" item="&itHeliumAssembly;"/>
		</Items>

		<Image imageID="&rsBritannia;" imageWidth="80" imageHeight="80"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="154"	posRadius="26"	posZ="0"	rotation="180"/>
			<Effect type="thrustMain"		posAngle="-154"	posRadius="26"	posZ="0"	rotation="180"/>
			<Effect type="rotateRight"		posAngle="82"	posRadius="23"	posZ="0"	rotation="0"/>
			<Effect type="rotateRight"		posAngle="-98"	posRadius="23"	posZ="0"	rotation="180"/>
			<Effect type="rotateLeft"		posAngle="-82"	posRadius="23"	posZ="0"	rotation="0"/>
			<Effect type="rotateLeft"		posAngle="98"	posRadius="23"	posZ="0"	rotation="180"/>
		</Effects>

		<Events>
			<Reload>
				(block (theMissilePod)
					(setq theMissilePod (item (objGetItems gSource "lI") 0))
					(if theMissilePod
						; Tell the missile pod to reload itself
						(objFireItemEvent gSource theMissilePod "Reload")
						)
					)
			</Reload>
		</Events>

		<AISettings
			fireRateAdj=		"15"
			fireAccuracy=		"90"
			perception=			"4"
			
			combatStyle=		"advanced"
			/>
	</ShipClass>

	<!-- Centurion-class Heavy Gunship -->

	<ShipClass UNID="&scCenturion;"
			manufacturer=		"Pacific Defense Corporation"
			class=				"Centurion"
			type=				"heavy gunship"
			defaultSovereign=	"&svCommonwealthFleet;"

			mass=				"90"
			cargoSpace=			"50"
			thrustRatio=		"9.0"
			maxSpeed=			"20"

			attributes=			"commonwealth, commonwealthMilitary, commonMilitary, genericClass"
			>

		<Armor>
			<ArmorSection start="315" span="90" armorID="&itBlastPlate;" areaSet="0,2" />
			<ArmorSection start="225" span="90" armorID="&itBlastPlate;" areaSet="3,4" />
			<ArmorSection start="135" span="90" armorID="&itBlastPlate;" areaSet="1,6" />
			<ArmorSection start="45"  span="90" armorID="&itBlastPlate;" areaSet="7,13" />
		</Armor>

		<Devices>
			<Device deviceID="&itTeV9Blaster;"/>
			<Device deviceID="&itR1Deflector;"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"9.0"
			rotationAccel=		"1.0"
			/>

		<Items>
			<Item count="2d6" item="&itHeliumAssembly;"/>
		</Items>

		<Image imageID="&rsMediumShips2;" imageX="320" imageY="0" imageWidth="64" imageHeight="64"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="141"	posRadius="27"	posZ="0"	rotation="180"/>
			<Effect type="thrustMain"		posAngle="-141"	posRadius="27"	posZ="0"	rotation="180"/>
			<Effect type="rotateRight"		posAngle="82"	posRadius="23"	posZ="0"	rotation="0"/>
			<Effect type="rotateRight"		posAngle="-98"	posRadius="23"	posZ="0"	rotation="180"/>
			<Effect type="rotateLeft"		posAngle="-82"	posRadius="23"	posZ="0"	rotation="0"/>
			<Effect type="rotateLeft"		posAngle="98"	posRadius="23"	posZ="0"	rotation="180"/>
		</Effects>

		<AISettings
			fireRateAdj=		"20"
			fireAccuracy=		"85"
			perception=			"4"
			
			combatStyle=		"advanced"
			/>

	</ShipClass>

	<!-- Centurion/X-class Heavy Gunship -->

	<ShipClass UNID="&scCenturionX;"
			manufacturer=		"Pacific Defense Corporation"
			class=				"Centurion/X"
			type=				"heavy gunship"
			defaultSovereign=	"&svCommonwealthFleet;"

			mass=				"90"
			cargoSpace=			"50"
			thrustRatio=		"12.0"
			maxSpeed=			"22"

			attributes=			"commonwealth, commonwealthMilitary, commonMilitary, genericClass"
			>

		<Armor>
			<ArmorSection start="315" span="90" armorID="&itP120HexphaseArmor;" areaSet="0,2" />
			<ArmorSection start="225" span="90" armorID="&itP120HexphaseArmor;" areaSet="3,4" />
			<ArmorSection start="135" span="90" armorID="&itP120HexphaseArmor;" areaSet="1,6" />
			<ArmorSection start="45"  span="90" armorID="&itP120HexphaseArmor;" areaSet="7,13" />
		</Armor>

		<Devices>
			<Device deviceID="&itStarCannon;"/>
			<Device deviceID="&itR5Deflector;"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"12.0"
			rotationAccel=		"1.0"
			/>

		<Items>
			<Item count="2d6" item="&itHeliumAssembly;"/>
		</Items>

		<Image imageID="&rsMediumShips2;" imageX="320" imageY="0" imageWidth="64" imageHeight="64"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="141"	posRadius="27"	posZ="0"	rotation="180"/>
			<Effect type="thrustMain"		posAngle="-141"	posRadius="27"	posZ="0"	rotation="180"/>
			<Effect type="rotateRight"		posAngle="82"	posRadius="23"	posZ="0"	rotation="0"/>
			<Effect type="rotateRight"		posAngle="-98"	posRadius="23"	posZ="0"	rotation="180"/>
			<Effect type="rotateLeft"		posAngle="-82"	posRadius="23"	posZ="0"	rotation="0"/>
			<Effect type="rotateLeft"		posAngle="98"	posRadius="23"	posZ="0"	rotation="180"/>
		</Effects>

		<AISettings
			fireRateAdj=		"15"
			fireAccuracy=		"90"
			perception=			"4"
			
			combatStyle=		"advanced"
			/>

	</ShipClass>

	<!-- CSC Task Force Encounter
	
	GLOBAL DATA

	shipsLeft: A list of ships not yet deployed.

	-->

	<EncounterType UNID="&stCSCTaskForceEncounter;"
			name=				"(CSC Task Force)"
			sovereign=			"&svCommonwealthFleet;"

			attributes=			"fleet,friendly,envAir,envEarth,envFire,envWater"
			levelFrequency=		"----- -ucu- ----- ----- -----"
			maxAppearing=		"2-4"
			unique=				"inSystem"
			locationCriteria=	"+outerSystem, -planetary"
			enemyExclusionRadius="50"
			>

		<StaticData>
			<CSCData>
				{
					america:
						{	name: "CSC America" 
							emblem: (resCreateImageDesc &rsFleetEmblems; 320 0 320 240)
							}
							
					atlantica:
						{	name: "CSC Atlantica" 
							emblem: (resCreateImageDesc &rsFleetEmblems; 320 240 320 240)
							}
							
					asia:
						{	name: "CSC Asia" 
							emblem: (resCreateImageDesc &rsFleetEmblems; 0 240 320 240)
							}
							
					india:
						{	name: "CSC India" 
							emblem: (resCreateImageDesc &rsFleetEmblems; 0 480 320 240)
							}
							
					pacifica:	
						{	name: "CSC Pacifica" 
							emblem: (resCreateImageDesc &rsFleetEmblems; 320 480 320 240)
							}
					}
			</CSCData>
		</StaticData>

		<GlobalData>
			<shipsLeft>
				("america" "atlantica" "asia" "india" "pacifica")
			</shipsLeft>
		</GlobalData>

		<Ships>
			<Ship	count="1"	class="&scCSCTaskForce;" orders="hold">
				<OnCreate>
					(block (shipsLeft shipToCreate dataEntry)

						; Pick a random ship
						(setq shipsLeft (typGetData &stCSCTaskForceEncounter; 'shipsLeft))
						(setq shipToCreate (if (not shipsLeft) "america" (random shipsLeft)))
						(setq dataEntry (@ (typGetStaticData &stCSCTaskForceEncounter; 'CSCData) shipToCreate))

						; Remove from list
						(typSetData &stCSCTaskForceEncounter; 'shipsLeft 
							(filter shipsLeft theShip 
								(not (eq theShip shipToCreate))
								)
							)

						; Name the ship

						(objSetName gSource (@ dataEntry 'name) 0x01)
						(objSetData gSource 'CSC shipToCreate)
						(objSetData gSource 'CSCData (eval dataEntry))
						)
				</OnCreate>

				<Escorts>
					<Ship					count="1"	class="&scCenturion;"	orders="guard" controller="fleetcommand">
						<Escorts>
							<Ship     count="6"	class="&scCenturion;"	orders="escort" controller="fleet"/>
						</Escorts>
					</Ship>
					<Ship					count="1"	class="&scCenturion;"	orders="guard" controller="fleetcommand">
						<Escorts>
							<Ship     count="6"	class="&scCenturion;"	orders="escort" controller="fleet"/>
						</Escorts>
					</Ship>
				</Escorts>
			</Ship>
		</Ships>
	</EncounterType>

	<!-- CSC Arctica Encounter -->

	<EncounterType UNID="&stCSCArcticaEncounter;"
			name=				"(CSC Arctica)"
			sovereign=			"&svCommonwealthFleet;"

			attributes=			"fleet,friendly,envAir,envEarth,envFire,envWater"
			levelFrequency=		"----- ruu-- ----- ----- -----"
			maxAppearing=		"1"
			locationCriteria=	"*"
			enemyExclusionRadius="50"
			>

		<Ships>
			<Ship	count="1"	class="&scCSCHospital;" orders="hold">
				<OnCreate>
					(block Nil
						(objSetName gSource "CSC Arctica" 0x01)
						(objSetData gSource 'CSC 'arctica)
						(objSetData gSource 'CSCData {
							name: "CSC Arctica"
							emblem: (resCreateImageDesc &rsFleetEmblems; 960 0 320 240)
							})
						)
				</OnCreate>

				<Escorts>
					<Ship     count="2d6"	class="&scCenturion;"	orders="patrol" patrolDist="15"/>
				</Escorts>
			</Ship>
		</Ships>
	</EncounterType>

	<!-- CSC Sahara Encounter -->

	<EncounterType UNID="&stCSCSaharaEncounter;"
			name=				"(CSC Sahara)"
			sovereign=			"&svCommonwealthFleet;"

			attributes=			"fleet,friendly,envAir,envEarth,envFire,envWater"
			levelFrequency=		"----- ruu-- ----- ----- -----"
			maxAppearing=		"1"
			locationCriteria=	"*"
			enemyExclusionRadius="50"
			>

		<Ships>
			<Ship	count="1"	class="&scCSCHospital;" orders="hold">
				<OnCreate>
					(block Nil
						(objSetName gSource "CSC Sahara" 0x01)
						(objSetData gSource 'CSC 'sahara)
						(objSetData gSource 'CSCData {
							name: "CSC Sahara"
							emblem: (resCreateImageDesc &rsFleetEmblems; 640 480 320 240)
							})
						)
				</OnCreate>

				<Escorts>
					<Ship     count="2d6"	class="&scCenturion;"	orders="patrol" patrolDist="15"/>
				</Escorts>
			</Ship>
		</Ships>
	</EncounterType>

	<!-- Station used for scientist rescue mission -->

	<StationType UNID="&stRogueBaseRescue;"
			name=				"Rogue Fleet settlement"
			sovereign=			"&svRogueFleet;"
			abandonedScreen=	"Main"
			dockingPorts=		"8"
			canAttack=			"true"

			multiHull=			"true"
			armorID=			"&itP120HexphaseArmor;"
			maxHitPoints=		"250"
			hitPoints=			"0"
			regen=				"6"
			shipRegen=			"6"
			fireRateAdj=		"20"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"enemy, envAir, envAvoidsFire, human, populated, rogue"
			>

		<Image			imageID="&rsStations8;" imageX="128" imageY="896" imageWidth="128" imageHeight="128"/>

		<Devices>
			<Device deviceID="&itStarCannon;"	omnidirectional="true"/>
		</Devices>

		<Ships>
			<Ship		count="1"		class="&scCenturionX;" orders="patrol" patrolDist="20"/>
			<Ship		count="1d2+1"	class="&scCenturion;" orders="patrol" patrolDist="20"/>
			<Ship		count="1d2"		class="&scCenturion;" orders="guard"/>
		</Ships>

		<DockScreens>
			<Main>

				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen "Smoke, debris, and blast marks remain after a ferocious battle. No one is left alive.")
						</OnPaneInit>

						<Actions>
							<Action name="Undock" cancel="1" default="1" key="U">
								<Exit/>
							</Action>
						</Actions>

					</Default>
				</Panes>
			</Main>
		</DockScreens>

	</StationType>

	<Globals>
		(block Nil
			(setq intFleetCreateWingmen (lambda (missionObj aCount theClass)
				(block (
					(baseObj (objGetObjByID (msnGetProperty missionObj 'ownerID)))
					(missionID (msnGetProperty missionObj 'id))
					)
					(if (not theClass)
						(setq theClass &scCenturion;)
						)
					(for i 0 (- aCount 1)
						(block (wingmanObj)
							(setq wingmanObj (sysCreateShip
								theClass
								baseObj
								&svCommonwealthFleet;
								'fleet
								))
							(shpOrder wingmanObj 'escort gPlayerShip i)

							;	Keep track of wingmen
							(objSetData wingmanObj (cat missionID "_wingman") True)
							(msnRegisterForEvents missionObj wingmanObj)
							)
						)
					)
				))

			(setq intFleetCrime (lambda (severity description)
				(if (gr severity (int (objGetData gPlayerShip "fleetCrimeSeverity")))
					(block Nil
						(objSetData gPlayerShip "fleetCrimeSeverity" severity)
						(objSetData gPlayerShip "fleetCrime" description)
						)
					)
				))

			(setq intFleetDisperseWingmen (lambda (missionObj)
				(block (
					(baseObj (objGetObjByID (msnGetProperty missionObj 'ownerID)))
					(missionID (msnGetProperty missionObj 'id))
					(wingmen (sysFindObject Nil (cat "sA D:" missionID "_wingman;")))
					)
					(enum wingmen wingmanObj
						(block Nil
							(shpCancelOrders wingmanObj)
							(shpOrder wingmanObj 'dock baseObj)
							(shpOrder wingmanObj 'gate)
							)
						)
					(count wingmen)
					)
				))
				
			(setq fltOrderCheckPosition (lambda (theCSC)
				(block (enemyObj)
					; Are we in a good spot? If not, then we need to move
					(if (and (setq enemyObj (sysFindObject theCSC "TAEPN"))
							(leq (objGetDistance theCSC enemyObj) 80)
							)
						(block (dest bearing)
							; bearing away from enemy
							(setq bearing 
								(sysVectorAngle (sysVectorSubtract (objGetPos theCSC) (objGetPos enemyObj)))
								)
								
							; Pick a better spot that is away from the enemy
							(setq dest (sysVectorRandom theCSC 
								(lambda Nil
									(sysVectorPolarOffset Nil
										(modulo (add bearing 360 (random -80 80)) 360)
										(random 120 180)
										)
									)
								100 
								"TA"
								))
							
							; Order the ship to move
							(shpCancelOrders theCSC)
							(shpOrder theCSC 'holdCourse
								(sysVectorAngle (sysVectorSubtract dest (objGetPos theCSC)))
								(sysVectorDistance dest (objGetPos theCSC))
								)

							(objSetData theCSC "behavior" 'moving)
							(objSetProperty theCSC 'dockingEnabled Nil)
							True
							)
						Nil
						)
					)
				))

			(setq cscSquadronCreateShip (lambda (theCSC theClass)
				(block (theShip theEntry squadronList)
				
					; Create the ship
					(setq theShip (sysCreateShip theClass theCSC (objGetSovereign theCSC)))
					(objSuspend theShip)
					
					; Create the squadron entry
					(setq theEntry (list (objGetID theShip) theClass 'home))
					
					; Append to the squadron list
					
					(setq squadronList (append (objGetData theCSC "squadron") (list theEntry)))
					(objSetData theCSC "squadron" squadronList)
					
					;(dbgOutput (objGetID theShip) ": Created " (typGetDataField theClass "name"))
					)
				))
				
			(setq cscSquadronDeployShip (lambda (theCSC theClass)
				(block (theID theShip squadronList)
					
					; Look for a ship that matches the class and is currently
					; at "home"
					
					(setq squadronList (objGetData theCSC "squadron"))
					(setq theID (item (match squadronList theEntry (and (eq (item theEntry 1) theClass) (eq (item theEntry 2) 'home))) 0))
					
					; If we found one, deploy the ship
					(if (and theID (setq theShip (objGetObjByID theID)))
						(block Nil
							
							; Ship appears out of the CSC
							(objResume theShip theCSC)
							(objRegisterForEvents theCSC theShip)
							
							; Update squadron list
							(setq squadronList 
								(map squadronList theEntry
									(if (eq (item theEntry 0) theID)
										; Update this entry
										(list theID (item theEntry 1) 'deployed)
										
										; Leave the entry alone
										theEntry
										)
									)
								)
								
							(objSetData theCSC "squadron" squadronList)
							
							;(dbgOutput theID ": Deployed")
							
							; Done
							theShip
							)
							
						; Otherwise, couldn't deploy
						Nil
						)
					)
				))

			(setq intFleetPromotion (lambda Nil
				; Returns level that the player is promoted to (or Nil)

				(block (xp newLevel)
					(setq xp (objGetData gPlayerShip "fleetXP"))
					(switch
						(geq xp 10000)
							(setq newLevel 6)

						(geq xp 3000)
							(setq newLevel 5)

						(geq xp 1500)
							(setq newLevel 4)

						(geq xp 600)
							(setq newLevel 3)

						(geq xp 200)
							(setq newLevel 2)

						(setq newLevel 1)
						)

					; Return if different from current level
					(if (eq (objGetData gPlayerShip "fleetLevel") newLevel)
						Nil
						newLevel
						)
					)
				))

			(setq commFleet_GiveReward (lambda (missionObj)
				(block Nil
					;	Pay the player and record the award
					(rpgMissionRewardPayment (msnGetData missionObj 'reward))
					;	Increase XP
					(objIncData gPlayerShip 'fleetXP (msnGetData missionObj 'missionXP))

					;	dsRPGMission checks for a well-known data member in the mission
					;	object to see if it should navigate to an additional screen.
					(if (and missionObj (intFleetPromotion))
						(msnSetData missionObj 'rewardNextScreen &dsFleetPromotion;)
						)
					)
				))
			)
	</Globals>

	<EncounterTable UNID="&etKobolAmbush1;">
		<Table count="1d3+2">
			<Ship chance="50"	count="1"	class="&scKobolGunshipDualTeV9;"	orders="attack" sovereign="&svKobolWarlords;"/>
			<Ship chance="30"	count="1"	class="&scKobolGunshipOmniTeV9;"	orders="attack" sovereign="&svKobolWarlords;"/>
			<Ship chance="20"	count="1"	class="&scKobolGunshipMissiles;"	orders="attack" sovereign="&svKobolWarlords;"/>
		</Table>
	</EncounterTable>

	<!-- Fleet Delivery	-->

	<DockScreen UNID="&dsFleetDelivery;"	nestedScreen="true">

		<Panes>
			<Default>
				<OnPaneInit>
					(block (items)
						(setq items (objGetData gSource "fleetMissionCargo"))

						; See if the player has all the items that we expect
						(setq gResult True)
						(enum items thisItem
							(if (not (objHasItem gPlayerShip thisItem))
								(setq gResult Nil)
								)
							)

						(if gResult
							(scrSetDesc gScreen "The dockmaster meets you as you dock: \"Thank you for bringing these supplies&#x97;our situation is desperate.\"")
							(scrSetDesc gScreen "The dockmaster meets you as you dock: \"Where are the supplies that you were supposed to be bringing? Those supplies are desperately needed!\"")
							)
						)
				</OnPaneInit>

				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(block Nil
							(if gResult
								(block (items missionObj)
									; Remove the supplies
									(setq missionObj (objGetObjRefData gPlayerShip "fleetMission"))
									(setq items (objGetData gSource "fleetMissionCargo"))

									(enum items thisItem
										(objRemoveItem gPlayerShip thisItem)
										)

									; Mission is a success
									(objSetData missionObj "MissionStatus" "success")
									(typIncGlobalData &scCSCTaskForce; "missionsCompleted")
									(objSetData gSource "fleetMissionCargo" Nil)
									(objSetObjRefData gPlayerShip "fleetMission" Nil)
									(shpCancelOrders gPlayerShip)
									)
								)

							(scrExitScreen gScreen)
							)
					</Action>
				</Actions>
			</Default>
		</Panes>

		<Events>
			<GetGlobalDockScreen>
				; If we have a delivery mission to this station, then show
				; the proper screen.
				;
				; The screen is shown with mission priority (4) meaning that
				; it will show up after decon and confiscation screens.
				
				(if	(and (objMatches gSource Nil "sTAV")
						(objGetData gSource "fleetMissionCargo")
						)
					(list &dsFleetDelivery; 4)
					Nil
					)
			</GetGlobalDockScreen>
		</Events>
	</DockScreen>

	<!-- Fleet only allows docking with military ID	-->

	<DockScreen UNID="&dsFleetRefuseDock;"	nestedScreen="true">
		<Panes>
			<Default>
				<OnPaneInit>
					(scrSetDesc gScreen 
						(cat "As you exit the docking ramp, Commonwealth troopers train their weapons on you:\n\n\"This is a military "
							 (if (objIsShip gSource) "ship" "installation")
							 ", civie!\""
							 )
						)
				</OnPaneInit>

				<Actions>
					<Action name="Undock" default="1" cancel="1" key="U">
						(scrExitScreen gScreen 'forceUndock)
					</Action>
				</Actions>
			</Default>
		</Panes>
	</DockScreen>

	<!-- Fleet Promotion -->

	<DockScreen UNID="&dsFleetPromotion;"
			nestedScreen=	"true"
			inherit=		"&dsDockScreenBase;"
			>
		<Panes>
			<Default>
				<OnPaneInit>
					(block (
						(newLevel (intFleetPromotion))
						)
						(scrSetDescTranslate gScreen (cat "Promotion:" newLevel) {
							captainName: (cat "the captain of " (objGetName gSource 4))
							})

						(switch
							(= newLevel 2)
								(objAddItem gPlayerShip (itmCreate &itAresCampaignRibbon; 1))
							)

						(objSetData gPlayerShip "fleetLevel" newLevel)
						)
				</OnPaneInit>

				<Actions>
					<Action id="actionContinue" default="1" cancel="1">
						(scrExitScreen gScreen)
					</Action>
				</Actions>
			</Default>
		</Panes>

		<Language>
			<Text id="Promotion:2">
				(cat
					"In recognition of your service to the Fleet, " (@ gData 'captainName)
					" awards you the title of Privateer and bestows upon you the Ares Campaign Ribbon."
					)
			</Text>
			<Text id="Promotion:3">
				(cat
					"In recognition of your service to the Fleet, " (@ gData 'captainName)
					" awards you the rank of master sergeant in the Commonwealth Fleet."
					)
			</Text>
			<Text id="Promotion:4">
				(cat
					"In recognition of your service to the Fleet, " (@ gData 'captainName)
					" promotes you to the rank of Fleet lieutenant."
					)
			</Text>
			<Text id="Promotion:5">
				(cat
					"In recognition of your service to the Fleet, " (@ gData 'captainName)
					" promotes you to the rank of Fleet commander."
					)
			</Text>
			<Text id="Promotion:6">
				(cat
					"In recognition of your service to the Fleet, " (@ gData 'captainName)
					" promotes you to the rank of Fleet captain."
					)
			</Text>
		</Language>
	</DockScreen>

	<!-- Fleet Crime Warning -->

	<DockScreen UNID="&dsFleetCrimeWarning;"	nestedScreen="true">
		<Panes>
			<Default>
				<OnPaneInit>
					(scrSetDesc gScreen (plyComposeString gPlayer (cat
						"As you leave your ship a Fleet officer approaches you:\n\n"
						"\"One moment, %sir%! Looks like you've been tagged by the Commonwealth for some kind of incident. "
						"The record lists '" (objGetData gPlayerShip "commonCrime") ",' which is...uh...a serious crime, %sir%. "
						"Probably a mistake, %sir%, I think. I just thought you'd want to know.\""
						)))
				</OnPaneInit>

				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(block Nil
							(typSetGlobalData &svCommonwealthFleet; "commonCrimeWarning" (objGetData gPlayerShip "commonCrime"))
							(scrExitScreen gScreen)
							)
					</Action>
				</Actions>
			</Default>
		</Panes>
	</DockScreen>

	<!-- Fleet Decontamination -->

	<DockScreen UNID="&dsFleetDecon;"	nestedScreen="true">
		<Panes>
			<Default>
				<OnPaneInit>
					(block Nil
						(scrSetDesc gScreen "The dockmaster decontaminates your ship before you are allowed to exit the airlock.")
						(shpDecontaminate gPlayerShip)
						)
				</OnPaneInit>

				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(scrExitScreen gScreen (shpIsRadioactive gPlayerShip))
					</Action>
				</Actions>

			</Default>
		</Panes>
	</DockScreen>

	<!-- Fleet Discharge -->

	<DockScreen UNID="&dsFleetDischarge;"	nestedScreen="true">
		<Panes>
			<Default>
				<OnPaneInit>
					(block Nil
						(scrSetDesc gScreen (cat 
							"As you enter you are surrounded by heavily armed soldiers. A Fleet officer approaches you:\n\n"
							
							(switch
								(gr (objGetData gPlayerShip "fleetXP") 0)
									"\"Because of your crimes against the Commonwealth you are hereby discharged from the Fleet.\""
									
								(objGetItems gPlayerShip "* +commonwealth; +militaryID")
									"\"Because of your crimes against the Commonwealth your military ID is hereby revoked.\""
									
								"\"You're nothing but a common criminal, not even worth putting in the locker.\""
								)
								
							"\n\nThe soldiers escort you back to your ship."
							))
						)
				</OnPaneInit>

				<Actions>
					<Action name="Undock" default="1" cancel="1" key="U">
						(block (milIDs)
							(objSetData gPlayerShip "fleetLevel" 1)
							(objSetData gPlayerShip "fleetXP" 0)
							(enum (objGetItems gPlayerShip "* +commonwealth; +militaryID") theItem
								(objRemoveItem gPlayerShip theItem)
								)
							(scrExitScreen gScreen 'forceUndock)
							)
					</Action>
				</Actions>
			</Default>
		</Panes>
	</DockScreen>
	
	<!-- Fleet Imprison -->

	<DockScreen UNID="&dsFleetImprison;"	nestedScreen="true">
		<Panes>
			<Default>
				<OnPaneInit>
					(block Nil
						(scrSetDesc gScreen (cat "As you enter you are surrounded by heavily armed soldiers. A Fleet officer approaches you: \"You are charged with treason for " (objGetData gPlayerShip "fleetCrime") "\"" ))
						)
				</OnPaneInit>

				<Actions>
					<Action name="Continue" default="1" cancel="1" key="C">
						(block Nil
							(plyDestroyed gPlayer (cat "was executed for " (objGetData gPlayerShip "fleetCrime")))
							(scrExitScreen gScreen 'forceUndock)
							)
					</Action>
				</Actions>

			</Default>
		</Panes>
	</DockScreen>
	
<!-- THE COMMONWEALTH FLEET

	GLOBAL DATA
	
	medsDonated:		Cost of total medical supplies donated
	
-->

	<Sovereign UNID="&svCommonwealthFleet;"
			name=":the Commonwealth Fleet"
			shortName=":the Fleet"
			adjective="Fleet"
			demonym=":a Fleet crewmember(s)"

			alignment="constructive chaos"
			>

		<Events>
			<GetGlobalAchievements>
				(block (theList p262prototype antarcticaStatus medsDonated)

					; Rank
					
					(if (gr (objGetData gPlayerShip "fleetXP") 0)
						(block (
							(rank (objGetData gPlayerShip "fleetLevel"))
							(successList (plyGetKeyEventStat gPlayer 'missionSuccess Nil "* +commonwealthFleet;"))
							(failureList (plyGetKeyEventStat gPlayer 'missionFailure Nil "* +commonwealthFleet;"))
							)

							(setq theList (list
								(list
									"Commonwealth Fleet rank"
									(typTranslate &svCommonwealthFleet; 'PlayerRank)
									)
									
								(list
									"CSC missions"
									(rpgMissionAchievementString (count successList) (count failureList))
									"missions &amp; activities"
									)
								))
							)
						)
						
					; Project262 prototype
					
					(setq p262prototype (typGetGlobalData &scCSCTerra; "p262protoype"))
					(if p262prototype
						(setq theList (append theList (list
							(list
								(switch
									(eq p262prototype 'recovered) "Recovered Project Lamplighter prototype"
									(cat "ERROR: p262prototype: " p262prototype)
									)
								Nil
								"achievements &amp; regrets"
								)
							)))
						)
						
					; Lamplighter
					
					(if (eq (typGetGlobalData &scCSCTerra; "p262test") 'installed)
						(setq theList (append theList (list
							(list "Acquired Lamplighter archcannon" Nil "achievements &amp; regrets")
							)))
						)
						
					; Antarctica
					
					(setq antarcticaStatus (typGetGlobalData &scCSCTerra; "antarctica"))
					(if antarcticaStatus
						(setq theList (append theList (list
							(list
								(switch
									(eq antarcticaStatus 'escaped) "Defended the CSC Antarctica"
									(eq antarcticaStatus 'destroyed) "Failed to defend the CSC Antarctica"
									(eq antarcticaStatus 'destroyedByPlayer) "Destroyed the CSC Antarctica"
									(eq antarcticaStatus 'betrayed) "Betrayed the CSC Antarctica"
									(cat "ERROR: antarctica: " antarcticaStatus)
									)
								Nil
								"achievements &amp; regrets"
								)
							)))
						)
						
					; Meds donated
					
					(if (setq medsDonated (typGetGlobalData &svCommonwealthFleet; "medsDonated"))
						(setq theList (append theList (list
							(list "Value of supplies donated to Commonwealth Fleet" medsDonated "missions &amp; activities")
							)))
						)

					theList
					)
			</GetGlobalAchievements>
			
			<GetGlobalDockScreen>
				(switch
					; This only applies to Fleet ships and stations
					(not (objMatches gSource Nil "sTAV +commonwealthFleet;"))
						Nil
						
					; If the ship is radioactive then we need to decontaminate
					(shpIsRadioactive gPlayerShip)
						(list &dsFleetDecon; 10)
						
					; The remaining screens are only invoked if the ship/station
					; implements Fleet Law (e.g., CSC Antarctica does not).
					(not (objHasAttribute gSource "fleetLaw"))
						Nil
						
					; If the player has committed a crime, then imprisonment
					(geq (int (objGetData gPlayerShip "fleetCrimeSeverity")) 2)
						(list &dsFleetImprison; 8)
						
					; If the player has committed a Commonwealth crime then she
					; is kicked out of the military.
					(and (geq (int (objGetData gPlayerShip "commonCrimeSeverity")) 2)
							(leq (objGetData gPlayerShip "fleetLevel") 3))
						(list &dsFleetDischarge; 8)
						
					; If the player does not have a military ID, then
					; refuse dock
					(not (objGetItems gPlayerShip "*+MilitaryID"))
						(list &dsFleetRefuseDock; 6)
						
					; If the player has committed a Commonwealth crime but is a
					; Fleet lieutenant or higher, then she gets a warning.
					(and (geq (int (objGetData gPlayerShip "commonCrimeSeverity")) 2)
							(not (eq (typGetGlobalData &svCommonwealthFleet; 'commonCrimeWarning) (objGetData gPlayerShip "commonCrime"))))
						(list &dsFleetCrimeWarning; 5)

					Nil
					)
			</GetGlobalDockScreen>

			<OnGlobalUniverseCreated>
				(block Nil
					; Initialize all variables that we need
					(objSetData gPlayerShip "fleetXP" 0)
					(objSetData gPlayerShip "fleetLevel" 1)
					)
			</OnGlobalUniverseCreated>
		</Events>

		<Language>
			<Text id="PlayerRank">
				(block (
					(rank (objGetData gPlayerShip "fleetLevel"))
					)
					(switch
						(= rank 1) "Civilian"
						(= rank 2) "Privateer"
						(= rank 3) "Master sergeant"
						(= rank 4) "Fleet lieutenant"
						(= rank 5) "Fleet commander"
						(= rank 6) "Fleet captain"
						(cat "ERROR: Fleet rank: " rank)
						)
					)
			</Text>
		</Language>
	</Sovereign>
	
<!-- EFFECTS -->

	<EffectType unid="&efLamplighterProjectile;"
			instance=			"owner"
			>
		<Effect>
			<ParticlePattern
					style=			"comet"
					primaryColor=	"#ffe566"
					jitterLength=	"80-150"
					>
				<Events>
					<GetParameters>
						(block (
							(damageHP (@ gData 'damageHP))
							)
							{
								particleCount: (mathScale damageHP 50 680 100 300 50)
								length: (mathScale damageHP 50 680 80 220 50)
								width: (mathScale damageHP 50 680 8 24 50)
								}
							)
					</GetParameters>
				</Events>
			</ParticlePattern>
			
			<Orb
					style=				"smooth"
					animate=			"flicker"
					spikeCount=			"6"
						
					blendMode=			"screen"
					primaryColor=		"#fbffcc"
					secondaryColor=		"#ffe566"
					>
				<Events>
					<GetParameters>
						(block (
							(damageHP (@ gData 'damageHP))
							)
							{
								radius: (mathScale damageHP 50 680 30 80 50)
								intensity: (mathScale damageHP 50 680 20 50 50)
								}
							)
					</GetParameters>
				</Events>
			</Orb>
		</Effect>
	</EffectType>

<!-- RESOURCES -->

	<Image UNID="&rsAurochs;"		bitmap="Resources\Aurochs.jpg" bitmask="Resources\AurochsMask.bmp" loadOnUse="true"/>
	<Image UNID="&rsAurochsHD;"		bitmap="Resources\AurochsHD.jpg"	bitmask="Resources\AurochsHDMask.bmp" 	loadOnUse="true" />
	
	<Image UNID="&rsAquila;"		bitmap="Resources\Aquila.jpg" bitmask="Resources\AquilaMask.bmp" loadOnUse="true"/>
	<Image UNID="&rsBritannia;"		bitmap="Resources\Britannia.jpg" bitmask="Resources\BritanniaMask.bmp" loadOnUse="true"/>
	<Image UNID="&rsCSC;"			bitmap="Resources\CSC.jpg" bitmask="Resources\CSCMask.bmp" loadOnUse="true" />
	
	<Image UNID="&rsCSCBkgnd;"		bitmap="Resources\CSCScreen.jpg" loadOnUse="true" />
	<Image UNID="&rsFleetEmblems;"	bitmap="Resources\FleetEmblems.jpg" bitmask="Resources\FleetEmblemsMask.bmp" loadOnUse="true" />

</TranscendenceModule>
